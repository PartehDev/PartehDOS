(()=>{"use strict";var e,t={25443:(e,t,s)=>{var a=s(29087),n=s(16716),i=s(15672),o=s(92292),r=s(62830),c=s.n(r),d=s(75256),l=s(7064),u=s(88212);s(89907);self.jasmine;var f=s(82227),h=s(48868),p=s(34198),w=s(78134),g=s(71320),I=s(51501),y=s(95752),m=s(68906),L=s(33956),v=s(25051),E=s(42151),Z=s(95064);const b=[{listId:"meetup.com",name:"meetup.com",parentFolderType:"endsWith",subFolderType:"title",isIgnored:!1},{listId:"facebook.com",name:"facebook.com",parentFolderType:"endsWith",subFolderType:"title",isIgnored:!1},{listId:"google.com",name:"google.com",parentFolderType:"endsWith",subFolderType:"senderName",isIgnored:!1},{listId:"groupon",name:"groupon",parentFolderType:"endsWith",subFolderType:"senderName",isIgnored:!1},{listId:"xt.local",name:"xt.local",parentFolderType:"endsWith",subFolderType:"host",isIgnored:!1},{listId:"sparkpostmail.com",name:"sparkpostmail.com",parentFolderType:"endsWith",subFolderType:"host",isIgnored:!1},{listId:"list-id.mcsv.net",name:"list-id.mcsv.net",parentFolderType:"endsWith",subFolderType:"host",isIgnored:!1},{listId:"spc-",name:"sparkpostmail.com (spc-)",parentFolderType:"startsWith",subFolderType:"host",isIgnored:!1},{listId:"MAILING_LIST_GROUPS_UNCATEGORIZED",name:"",parentFolderType:"uncategorized",subFolderType:"host",isIgnored:!1}];var A=s(78614),O=s(95412),S=s(83065),M=s(65741),F=s(89175),R=s(5863),T=s(1407);const U="Contacts";class _{count=0;constructor(e,t){this.version=e,this.interval=setInterval((()=>this.total&&v.U.setStatus(T.A4,`Upgrade v${e} mail: ${t} ${this.count} / ${this.total}`)),1e3),u.ZP.info("Mail","Upgrade started: ",e)}stop(){clearInterval(this.interval),v.U.setStatus(T.A4,`Upgrade v${this.version} mail: Finalizing...`,5e3),u.ZP.info("Mail","Upgrade finished: ",this.version)}}h.Z.on("populate",(()=>{h.Z.filters.bulkAdd(Z.j),h.Z.mailingList.bulkAdd(b),h.Z._upgrades.add({version:h.Z.verno})})),h.Z.version(38).stores({messages:["[accountId+path+uid]","[accountId+path+hasRaw+uid]","[unTokenized+sentDate]"].join(","),searchList:["[accountId+path+uid]","internal","messageId","unFiltered","*viewIds"].join(","),threading:["[accountId+path+uid]","[unThreaded+accountId+path]","*references","inReplyTo","messageId"].join(","),mailboxCache:"[accountId+path],accountId",filters:"[accountId+path],unFiltered",buffer:"++_id,[accountId+path+uid+operation],accountId",folders:"accountId",views:"++_id,[accountId+path]"}).upgrade((e=>{e.messages.clear(),e.searchList.clear(),e.threading.clear(),e.folders.clear(),e.mailboxCache.clear(),e.filters.clear(),e.buffer.clear()})),h.Z.version(39).upgrade((e=>{const t="Feeds",s=[t,"",""],a=[t,"￿","￿"];e.messages.where("[accountId+path+uid]").between(s,a).delete(),e.searchList.where("[accountId+path+uid]").between(s,a).delete(),e.threading.where("[accountId+path+uid]").between(s,a).delete()})),h.Z.version(40).upgrade((e=>{const t=[U,""],s=[U,"￿"];e.filters.where("[accountId+path]").between(t,s).modify({unFiltered:1})})),h.Z.version(42).upgrade((e=>{e.messages.toCollection().modify((e=>{delete e.flags}))})),h.Z.version(43).stores({messages:["[accountId+path+uid]","[unTokenized+sentDate]"].join(","),searchList:["[accountId+path+uid]","[accountId+path+hasRaw+internal+uid]","internal","messageId","unFiltered","*viewIds"].join(",")}).upgrade((e=>{const t={};e.messages.toCollection().modify((e=>{const{accountId:s,path:a,uid:n,hasRaw:i,size:o}=e;t[s]||(t[s]={}),t[s][a]||(t[s][a]={}),t[s][a][n]={hasRaw:i,size:o},delete e.hasRaw})).then((()=>{e.searchList.toCollection().modify((e=>{const{accountId:s,path:a,uid:n}=e,i=t[s]&&t[s][a]&&t[s][a][n];i&&(e.hasRaw=i.hasRaw,e.size=i.size)}))}))})),h.Z.version(44).upgrade((e=>{const t=[];e.searchList.filter((e=>!e.flags)).each((e=>{const{accountId:s,path:a,uid:n}=e;t.push([s,a,n])})).then((()=>{h.Z.transaction("rw",[e.searchList,e.messages,e.threading],(()=>{e.searchList.where("[accountId+path+uid]").anyOf(t).delete(),e.messages.where("[accountId+path+uid]").anyOf(t).delete(),e.threading.where("[accountId+path+uid]").anyOf(t).delete()}))}))})),h.Z.version(45).upgrade((e=>{e.filters.toArray().then((t=>{const s=t.map((e=>{const{accountId:t,path:s}=e;return{accountId:t,path:s,type:R.Fz}}));e.views.bulkPut(s)})),e.searchList.toCollection().modify({unFiltered:1})})),h.Z.version(46).upgrade((e=>{e.filters.where("unFiltered").equals(0).modify((e=>{delete e.unFiltered}))})),h.Z.version(47).stores({drafts:"++id"}).upgrade((e=>{const t=[];e.messages.where("[accountId+path+uid]").between([R.of,"",0],[R.of,"￿",1/0]).modify((e=>{const{accountId:s,path:a,uid:n,bcc:i,bodyParts:o}=e;(i||o)&&(t.push({accountId:s,path:a,uid:n,bcc:i,bodyParts:o}),delete e.bcc,delete e.bodyParts)})).then((()=>e.drafts.bulkAdd(t)))})),h.Z.version(49).stores({searchList:["[accountId+path+uid]","[accountId+path+hasRaw+internal+uid]","[internal+accountId+path+uid]","messageId","unFiltered","*viewIds"].join(",")}),h.Z.version(50).stores({drafts2:"id",messages2:"[accountId+path+uid]",searchList2:"[accountId+path+uid]",threading2:"[accountId+path+uid]"}).upgrade((e=>Promise.all(["drafts","searchList","messages","threading"].map((t=>e[t].each((s=>e[t+"2"].add(s)))))))),h.Z.version(51).stores({drafts:null,messages:null,searchList:null,threading:null}),h.Z.version(52).stores({messages:["++id","&[accountId+path+uid]","[unTokenized+sentDate]"].join(","),searchList:["++id","&[accountId+path+uid]","[accountId+path+hasRaw+internal+uid]","[internal+accountId+path+uid]","messageId","unFiltered","*viewIds"].join(","),threading:["++id","&[accountId+path+uid]","[unThreaded+accountId+path]","*references","inReplyTo","messageId"].join(","),drafts:"id"}).upgrade((e=>{const t=[];e.searchList2.each((t=>e.searchList.add(t))).then((()=>e.threading2.each((t=>e.threading.add(t))))).then((()=>e.messages2.each((t=>(t.unTokenized=1,e.messages.add(t)))))).then((()=>e.drafts2.each((s=>{const{accountId:a,path:n,uid:i}=s;return e.messages.where("[accountId+path+uid]").equals([a,n,i]).each((e=>{t.push({...s,id:e.id})}))})))).then((()=>{e.drafts.clear(),e.drafts.bulkAdd(t)}))})),h.Z.version(56).stores({drafts:null,drafts2:null,messages2:null,searchList2:null,threading2:null,imap:"[accountId+path+uid],searchListId"}).upgrade((function(e){e.searchList.toArray().then((t=>t.forEach((t=>{const{id:s,accountId:a,path:n,uid:i,flags:o,internal:r}=t;r||[R.of,R.u4].includes(a)||e.imap.put({accountId:a,path:n,uid:i,searchListId:s}),e.messages.update(s,{flags:o})}))))})),h.Z.version(57).stores({filters2:"[accountId+path]",views2:"_id,[accountId+path]"}).upgrade((e=>(v.U.setStatus(T.A4,"Upgrade v57 mail: Copy view and filter tables",5e3),Promise.all(["filters","views"].map((t=>e[t].each((s=>e[t+"2"].add(s))))))))),h.Z.version(58).stores({filters:null,views:null}),h.Z.version(59).stores({filters:"++id,&[accountId+path],unFiltered",views:"++id,filterId",drafts:"id"}).upgrade((e=>{v.U.setStatus(T.A4,"Upgrade v59 mail: Change view table to PK",5e3),e.filters2.each((t=>{e.filters.add(t),e.views2.where("[accountId+path]").equals([t.accountId,t.path]).each((s=>{s.id=s._id,delete s._id,delete s.accountId,delete s.path,s.filterId=t.id,e.views.add(s)}))}))})),h.Z.version(61).stores({filters2:null,views2:null}).upgrade((function(e){v.U.setStatus(T.A4,"Upgrade v61 mail: Move all mailing lists to Other folder",5e3);const t=R.wC,s=[t,""],a=[t,"￿"],n=[];e.filters.where("[accountId+path]").between(s,a).modify((e=>{if(e.path!==R.ym&&e.path!==R.cs){const t=e.path.startsWith(R.cs)?e.path:R.cs+"/"+e.path;n.push(e.filterValue.include[0]);const s=e.filterValue||{};e.path=t,e.filterValue={...s,showMailingListsButton:!1,showFeedsButton:!1,showFeeds:!1,showMailingLists:!0}}else e.filterValue.showSubfolders=!0})).then((()=>{e.filters.where("[accountId+path]").anyOf([[t,R.cs],[t,R.ym]]).modify((e=>{e.filterValue.include=n,e.unFiltered=1}))})).then((()=>v.U.setStatus(T.A4,"Upgrade v61 mail: Finished",5e3)))})),h.Z.version(63).stores({drafts:null,filteringQueue:"++id,priority"}).upgrade((function(e){const t={},s=[];v.U.setStatus(T.A4,"Upgrade v63 mail: Generating filtering queue",5e3);const a=new _(63,"Generating filtering queue");e.searchList.where("unFiltered").aboveOrEqual(0).count().then((e=>{a.total=e})),e.searchList.where("unFiltered").aboveOrEqual(0).until((function(){return a.count++,!1})).modify((e=>{const{id:s,accountId:a,path:n,unFiltered:i}=e;i>0&&(t[a]||(t[a]={}),t[a][n]||(t[a][n]=[]),t[a][n].push(s)),delete e.unFiltered})).then((()=>{Object.keys(t).forEach((e=>{Object.keys(t[e]).forEach((s=>{const a=t[e][s];m.Z.call({type:"FILTERS_SLES",priority:R.Un.LOW,folderIds:[[e,s]],searchListIds:a,runAllMessages:!0,runMailingLists:!0,runFlagFolders:!0,runLabels:!0,runQueries:!0,runSingleThread:!0})}))}))})).then((()=>{a.stop()})),e.filters.where("unFiltered").aboveOrEqual(0).modify((e=>{e.unFiltered>0&&s.push(e.id),delete e.unFiltered})).then((()=>{s.length>0&&m.Z.call({type:"RUN_FILTERS",priority:R.Un.LOW,filterIds:s})}))})),h.Z.version(66).stores({searchList:["++id","&[accountId+path+uid]","[accountId+path+hasRaw+internal+uid]","[internal+accountId+path+uid]","messageId","*viewIds"].join(","),filters:"++id,&[accountId+path]",threading:["++id","unThreaded","*references","inReplyTo","messageId"].join(",")}).upgrade((function(e){const t=new _(66,"Updating threading");e.threading.count().then((e=>{t.total=e})),e.threading.toCollection().modify((e=>{delete e.accountId,delete e.path,delete e.uid,t.count++})).then((()=>{t.stop()}))})),h.Z.version(67).stores({threadingQueue:"++id"}).upgrade((function(e){const t=new _(67,"Removing unThreaded"),s=[];e.threading.where("unThreaded").aboveOrEqual(0).count().then((e=>{t.total=e})).then((()=>e.threading.where("unThreaded").aboveOrEqual(0).modify((e=>{e.unThreaded>0&&s.push(e.id),delete e.unThreaded,t.count++})))).then((()=>{if(s.length>0)return(0,L.Z)(s)})).then((()=>{t.stop()}))})),h.Z.version(69).stores({threading:["++id","*references","inReplyTo","messageId"].join(",")}).upgrade((function(e){const t=new _(69,"Updating");e.searchList.count().then((e=>{t.total=e})).then((()=>e.filters.toArray())).then((s=>{const a={};return s.forEach((e=>{const{accountId:t,path:s}=e;a[t]=a[t]||{},a[t][s]=e})),e.searchList.toCollection().modify((e=>{const{accountId:s,path:n}=e,i=a[s]&&a[s][n];e.sourceFilterIds=i?new Set([i.id]):new Set,t.count++}))})).then((()=>{t.stop()}))})),h.Z.version(70).stores({searchList:["++id","&[accountId+path+uid]","[internal+accountId+path+uid]","messageId","*viewIds"].join(","),imap:["[accountId+path+uid]","searchListId","[accountId+path+hasRaw+uid]"].join(",")}).upgrade((function(e){const t=new _(70,"Updating"),s=new Map;w.Z.Promise.all([e.searchList.count(),e.imap.count()]).then((e=>{t.total=e.reduce(((e,t)=>e+t))})).then((()=>e.searchList.toCollection().modify((e=>{const{id:a,hasRaw:n,size:i}=e;s.set(a,{hasRaw:n,size:i}),delete e.hasRaw,delete e.size,t.count++})))).then((()=>e.imap.toCollection().modify((e=>{const a=s.get(e.searchListId);if(!a)return void console.warn("imap update not found for "+JSON.stringify(e));const{hasRaw:n,size:i}=a;e.hasRaw=n,e.size=i,t.count++})))).then((()=>{t.stop()}))})),h.Z.version(71).stores({messages:["++id","[unTokenized+sentDate]"].join(","),searchList:["++id","messageId","*viewIds","*sourceFilterIds"].join(",")}).upgrade((function(e){const t=new _(71,"Updating");w.Z.Promise.all([e.searchList.count(),e.messages.count()]).then((e=>{t.total=e.reduce(((e,t)=>e+t))})).then((()=>e.searchList.toCollection().modify((e=>{e.sourceFilterIds=[...e.sourceFilterIds.values()],delete e.accountId,delete e.path,delete e.uid,t.count++})))).then((()=>e.messages.toCollection().modify((e=>{delete e.accountId,delete e.path,delete e.uid,t.count++})))).then((()=>{t.stop()}))})),h.Z.version(72).upgrade((function(){m.Z.call({priority:R.Un.LOW,type:"RUN_FILTERS",folderIds:[[R.of,R.N1]]})})),h.Z.version(73).upgrade((e=>e.searchList.toCollection().modify((e=>delete e.cc)))),h.Z.version(75).stores({accounts:"accountId"}).upgrade((function(e){e.folders.toArray().then((t=>{t.forEach((t=>{e.accounts.put({...t,capability:[]})}))}))})),h.Z.version(78).stores({messages:["++id","[unTokenized+sentDate]","gmailId"].join(","),folders:null}).upgrade((async e=>{const t=new _(78,"Updating");t.total=await e.searchList.count(),await e.searchList.toCollection().modify((e=>{e.to=e.to.slice(0,2),t.count++})),t.stop()})),h.Z.version(79).upgrade((async e=>{const t=new _(79,"Updating");t.total=2*await e.searchList.count(),await e.searchList.toCollection().modify((e=>{delete e.forwarded,t.count++})),await e.messages.toCollection().modify((e=>{"number"!=typeof e.forwarded&&delete e.forwarded,t.count++})),t.stop()})),h.Z.version(80).upgrade((async e=>{const t=new _(80,"Updating");t.total=await e.searchList.count(),await e.searchList.toCollection().modify((e=>{delete e.listId,t.count++})),t.stop()})),h.Z.version(83).stores({pop:"[accountId+uidl],searchListId"}).upgrade((async e=>{const t=new _(83,"Updating");t.total=await e.filters.count();const s=await e.accounts.toArray(),a={};s.forEach((e=>{const{accountId:t,folders:s}=e;if(!s)return;a[t]={};Object.getOwnPropertyNames(s).forEach((e=>{s[e].forEach((e=>{const{path:s,type:n}=e;a[t][s]=n}))}))})),await e.filters.toCollection().modify((e=>{const{accountId:t,path:s,filterValue:n}=e;t===R.u4&&(n.showFeeds=!0,n.showFeedsButton=!1,n.showMailingLists=!0,n.showMailingListsButton=!1),t===R.wC&&(n.showMailingListsButton=!1,n.showFeedsButton=!1);const i=a[t]&&a[t][s];switch(void 0!==i&&(n.showFeedsButton=!1),i){case R.Nz:case R.kY:n.showReadButton=!1;break;case R.uT:n.showDeletedButton=!1,n.exclude&&(n.exclude=n.exclude.filter((e=>!(Array.isArray(e)&&1===e.length&&Array.isArray(e[0].flags)&&1===e[0].flags.length&&"\\Deleted"===e[0].flags[0]))),0===n.exclude.length&&delete n.exclude)}})),t.stop()})),h.Z.version(84).upgrade((async e=>{const t=new _(84,"Fixing message table");t.total=await e.searchList.count(),await e.messages.toCollection().modify((e=>{e.from=e.from||[],e.to=e.to||[],e.cc=e.cc||[],e.replyTo=e.replyTo||[],e.listId=e.listId||"",t.count++})),t.stop()})),h.Z.version(85).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v85 mail: Adding Spam folder to All Messages");const t=I.Z.getAllViewTypes(),s=Z.j.find((e=>e.path===R.rp));if(s){const a=await e.filters.add(s);for(const s of t)await e.views.add({filterId:a,type:s});await m.Z.call({type:"RUN_FILTERS",priority:R.Un.LOW,filterIds:[a]})}v.U.setStatus(T.A4,"(Finished) Upgrade v85 mail: Adding Spam folder to All Messages",5e3)})),h.Z.version(86).stores({imap:["[accountId+path+uid]","searchListId","[accountId+path+hasRaw+uid]","[accountId+path+searchListId]","accountId"].join(","),pop:"[accountId+uidl],searchListId,accountId"}).upgrade((async e=>{const t=new _(86,"Upgrading message sources");t.total=await e.searchList.count(),await e.searchList.toCollection().modify((e=>{const s=!!e.internal,a=e.flags.includes(R.T4.DELETED);e.sources=new Map,e.sourceFilterIds.forEach((t=>{e.sources.set(t,{deleted:a,internal:s})})),delete e.internal,e.flags=e.flags.filter((e=>e!==R.T4.DELETED)),t.count++})),t.stop()})),h.Z.version(87).upgrade((async e=>{const t=new _(87,"VB-55503 Flattening MailAddressList properties");t.total=2*await e.searchList.count(),await e.searchList.toCollection().modify((e=>{e.from=(0,A.r_)(...e.from),e.to=(0,A.r_)(...e.to),t.count++})),await e.messages.toCollection().modify((e=>{e.bcc&&(e.bcc=(0,A.r_)(...e.bcc)),e.cc=(0,A.r_)(...e.cc),e.from=(0,A.r_)(...e.from),e.replyTo=(0,A.r_)(...e.replyTo),e.to=(0,A.r_)(...e.to),t.count++})),t.stop()})),h.Z.version(88).stores({searchList:["++id","messageId","*sourceFilterIds"].join(","),viewIds:"searchListId,*viewIds"}).upgrade((async e=>{const t=new _(88,"Moving message viewIds");t.total=await e.searchList.count();const s=[];await e.searchList.toCollection().modify((e=>{s.push({searchListId:e.id,viewIds:e.viewIds}),delete e.viewIds,t.count++})),await e.viewIds.bulkAdd(s),t.stop()})),h.Z.version(90).stores({messages:["++id","gmailId"].join(",")}).upgrade((async e=>{const t=new _(90,"Migrating buffer entries");t.total=await e.buffer.count(),await e.buffer.toCollection().modify((e=>{"SetCustomFlag"===e.operation?(e.operation="BUFFER_OPERATION_CUSTOM_FLAG",e.flagUpdates=e.params):"Delete"===e.operation?e.operation="BUFFER_OPERATION_DELETE":"Move"===e.operation?(e.operation="BUFFER_OPERATION_MOVE",e.destinationPath=e.params):"UploadMessage"===e.operation&&(e.operation="BUFFER_OPERATION_UPLOAD_MESSAGE",e.message=e.params),delete e.params,t.count++})),t.stop()})),h.Z.version(91).upgrade((async e=>{const t=new _(91,"Removing extra viewIds");t.total=await e.viewIds.count();const[s,a]=await w.Z.Promise.all([e.searchList.toCollection().primaryKeys(),e.viewIds.toCollection().primaryKeys()]),n=new Set(s),i=a.filter((e=>!n.has(e)));await e.viewIds.bulkDelete(i),t.stop()})),h.Z.version(92).upgrade((async e=>{const t=new _(92,"Migrating buffer entries");t.total=await e.buffer.count(),await e.buffer.toCollection().modify((e=>{"BUFFER_OPERATION_DELETE"===e.operation&&(e.operation="BUFFER_OPERATION_DELETE_IMAP"),t.count++})),t.stop()})),h.Z.version(95).stores({buffer:["++_id","[accountId+path+uid+operation]","accountId","[accountId+path+uid]","operation"].join(",")}).upgrade((async e=>{const t=new _(95,"Drafts storage change");t.total=await e.messages.count();const s=document.createElement("iframe");s.setAttribute("style","position:fixed; z-index:-1"),document.body&&document.body.appendChild(s);const a=s.contentDocument;await e.messages.toCollection().modify((e=>{const{bodyParts:s}=e;if(s){let t;if("text"===s[0].type){a.body&&a.body.remove();const e=a.documentElement;e&&e.append(document.createElement("body"));const n=a.body;n&&(n.innerText=s[0].content,t=[{...s[0],content:n.innerHTML,type:"html"},...s.slice(1,s.length)])}else s.length>1&&"html"===s[0].type&&"text"===s[1].type&&(t=[s[0],...s.slice(2,s.length)]);t&&(e.bodyParts=t)}t.count++})),s.remove(),t.stop()})),h.Z.version(96).upgrade((async e=>{const t=new _(96,"Remove flags from messages");t.total=2*await e.searchList.count();const s=new Map;await e.messages.toCollection().modify((async e=>{const a=e.flags.filter((e=>e!==R.T4.DELETED));s.set(e.id,a),delete e.flags,t.count++})),await e.searchList.toCollection().modify((async e=>{const a=s.get(e.id);a?e.flags=a||e.flags:console.warn("M3 upgrade 96 - flags not found for "+e.id),t.count++})),t.stop()})),h.Z.version(97).upgrade((async e=>{const t=new _(97,"Delete old groupon/meetup mailing lists"),s=[],a=[],n=[];if((await e.filters.where("[accountId+path]").between([R.wC,""],[R.wC,"￿"]).toArray()).forEach((e=>{e.path!==R.cs&&e.path!==R.W4&&e.filterValue.include&&e.filterValue.include.length>0&&e.filterValue.include[0]&&e.filterValue.include[0][0]&&e.filterValue.include[0][0].listIds&&e.filterValue.include[0][0].listIds.some((e=>e.endsWith(".groupon")||e.endsWith(".meetup.com")))&&s.push(e.id)})),s.length>0){(await e.views.where("filterId").anyOf(s).toArray()).forEach((e=>{a.push(e.id),"total"===e.type&&n.push(e.id)}));const i=[];t.total=await e.viewIds.where("viewIds").anyOf(n).count(),await e.viewIds.where("viewIds").anyOf(n).modify((e=>{t.count++,e.viewIds=e.viewIds.filter((t=>!a.includes(t)||(i.push(e.searchListId),!1)))})),await e.views.where("filterId").anyOf(s).delete(),await e.filters.where("id").anyOf(s).delete(),t.stop();const o=new _(97,"Make single folder for groupon/meetup mailing lists"),r=await e.messages.where("id").anyOf(i).toArray(),c=await p.Z.createMailingListFilters(r),d=I.Z.getAllViewTypes();o.total=c.length*d.length;for(const t of c)for(const s of d)await e.views.add({filterId:t.id,type:s}),o.count++;await m.Z.call({type:"RUN_FILTERS",priority:R.Un.LOW,filterIds:c.map((e=>e.id))}),await m.Z.call({type:"RUN_FILTERS",priority:R.Un.LOW,folderIds:[[R.wC,R.cs]]}),o.stop()}})),h.Z.version(98).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v98 mail: Mailing lists fix facebook/google parent folder",5e3);const t=["groups.facebook.com","google.com"];for(const s of t){const t=await e.filters.where("[accountId+path]").between([R.wC,`Other Mailing Lists/${s}/`],[R.wC,`Other Mailing Lists/${s}/￿`]).toArray(),a=[];t.forEach((e=>{e.filterValue.include&&e.filterValue.include.length>0&&e.filterValue.include[0]&&e.filterValue.include[0][0]&&e.filterValue.include[0][0].listIds&&a.push(...e.filterValue.include[0][0].listIds)})),a.length>0&&(await e.filters.where("[accountId+path]").equals([R.wC,R.cs+`/${s}`]).modify((e=>{e.filterValue.include[0][0].listIds=a})),await m.Z.call({type:"RUN_FILTERS",priority:R.Un.LOW,folderIds:[[R.wC,R.cs+`/${s}`]]}))}v.U.setStatus(T.A4,"(Finished) Upgrade v98 mail: Mailing lists fix facebook/google parent folder",5e3)})),h.Z.version(99).upgrade((async e=>{const t=new _(99,"Cleaning up viewIds");t.total=2*await e.viewIds.count();const s=[];await e.viewIds.toCollection().modify((async e=>{const{searchListId:a,viewIds:n}=e,i=new Set(n);i.size!==n.length&&(e.viewIds=[...i],s.push(a)),t.count++})),await m.Z.call({type:"RE_RUN_SLES",priority:R.Un.LOW,searchListIds:s}),t.stop()})),h.Z.version(100).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v100 mail: Clean broken filter in other mailing lists",5e3);let t=!1;await e.filters.where("[accountId+path]").equals([R.wC,R.cs]).modify((async e=>{if(e.filterValue.include&&e.filterValue.include.length>0&&e.filterValue.include[0]&&e.filterValue.include[0][0]&&e.filterValue.include[0][0].listIds){const s=e.filterValue.include[0][0].listIds.indexOf("");-1!==s&&(e.filterValue.include[0][0].listIds.splice(s,1),t=!0)}})),t&&await m.Z.call({type:"RUN_FILTERS",priority:R.Un.LOW,folderIds:[[R.wC,R.cs]]})})),h.Z.version(102).stores({flaggingQueue:"++id"}).upgrade((async e=>{const t=new _(102,"Refactor filters");t.total=await e.filters.count(),await e.filters.toCollection().modify((e=>{["include","exclude"].forEach((t=>{e.filterValue[t]&&e.filterValue[t].forEach(((s,a)=>{s.forEach(((s,n)=>{if(Object.keys(s).length>1||Array.isArray(Object.values(s)[0]))for(const i in s){if(Array.isArray(s[i])){let n=i;"listIds"===i?n="listId":"flags"===i&&(n="flag"),s[i].forEach((s=>{e.filterValue[t][a].push({[n]:s})}))}else e.filterValue[t][a].push({[i]:s[i]});e.filterValue[t][a][n]=void 0}})),e.filterValue[t][a]=e.filterValue[t][a].filter((e=>e))}))})),t.count++})),t.stop()})),h.Z.version(103).stores({buffer:["++_id","[accountId+path+operation]","accountId","[accountId+path]","operation"].join(",")}).upgrade((async e=>{const t=new _(103,"Updating buffer entries");t.total=await e.buffer.count(),await e.buffer.toCollection().modify((async e=>{void 0!==e.uid&&(e.uids=[e.uid],delete e.uid),t.count++})),t.stop()})),h.Z.version(104).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v104 mail: Mailing lists fix custom subfolder names",5e3),await e.filters.where("[accountId+path]").between([R.wC,""],[R.wC,"￿"]).modify((async e=>{const t=e.filterValue.name;e.filterValue.name=t.slice(t.lastIndexOf("/")+1)}))})),h.Z.version(105).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v105 mail: Fetching filters...",5e3);const t=await e.filters.toArray();v.U.setStatus(T.A4,"Upgrade v104 mail: Creating Junk views...",5e3);const s=t.map((e=>({filterId:e.id,type:R.Jq})));await e.views.bulkAdd(s),v.U.setStatus(T.A4,"Upgrade v105 mail: Updating filters...",5e3),await e.filters.where("[accountId+path]").equals([R.of,R.rp]).modify((e=>{const{filterValue:t}=e;t.include.push([{flag:"\\Junk"}]),t.showJunkButton=!1})),await e.filters.where("[accountId+path]").equals([R.u4,R.ym]).modify((e=>{const{filterValue:t}=e;t.exclude.push([{folder:R.Hd}]),t.exclude.push([{flag:"\\Junk"}]),t.showJunkButton=!1})),v.U.setStatus(T.A4,"Upgrade v105 mail: Fetching message IDs...",5e3);const a=await e.searchList.toCollection().keys();for(a.reverse(),v.U.setStatus(T.A4,"Upgrade v105 mail: Requesting re-filtering...",5e3);a.length>0;){const t=a.splice(0,5e3);await e.filteringQueue.add({priority:R.Un.LOW,type:"RE_RUN_SLES",searchListIds:t})}v.U.setStatus(T.A4,"Upgrade v105 mail: Done",5e3)})),h.Z.version(106).upgrade((async e=>{await e.filters.where("[accountId+path]").between([R.wC,""],[R.wC,"￿"]).modify((e=>{if(e.filterValue.include){const t=new Set,s=new Set;e.filterValue.include.forEach(((e,a)=>{e.forEach((e=>{e.listId?t.add(e.listId):e.senderIsMailingList&&s.add(e.senderIsMailingList)}))}));const a=[];t.forEach((e=>a.push([{listId:e}]))),s.forEach((e=>a.push([{senderIsMailingList:e}]))),e.filterValue.include=a}}))})),h.Z.version(107).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v107 mail: Split up flags and labels...",5e3);const t=I.Z.getAllViewTypes();await e.filters.where("[accountId+path]").anyOf([R.ut,R.ym],[R.ut,R.T4.RED],[R.ut,R.T4.ORANGE],[R.ut,R.T4.YELLOW],[R.ut,R.T4.GREEN],[R.ut,R.T4.BLUE],[R.ut,R.T4.PURPLE],[R.ut,R.T4.GRAY]).modify((e=>{e.accountId=R.MN}));const s=(0,E.Z)(Z.j).find((e=>e.accountId===R.ut)),a=[];if(await e.filters.where("[accountId+path]").between([R.ut,""],[R.ut,"￿"]).each((e=>{a.push(...e.filterValue.include)})),s){s.filterValue.include=a;const n=await e.filters.add(s);t.forEach((t=>e.views.add({filterId:n,type:t}))),await e.filteringQueue.add({priority:R.Un.LOW,type:"RUN_FILTERS",filterIds:[n],folderIds:[R.MN,R.ym]})}v.U.setStatus(T.A4,"Upgrade v107 mail: Done",5e3)})),h.Z.version(108).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v108 mail: Refresh Flag folders...",5e3),await e.filteringQueue.add({priority:R.Un.LOW,type:"RUN_FILTERS",folderIds:[[R.MN,R.ym],[R.MN,R.T4.RED],[R.MN,R.T4.ORANGE],[R.MN,R.T4.YELLOW],[R.MN,R.T4.GREEN],[R.MN,R.T4.BLUE],[R.MN,R.T4.PURPLE],[R.MN,R.T4.GRAY]],updateFilters:!0})})),h.Z.version(109).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v109 mail: Fixing some filters...",5e3);const t=await e.accounts.toCollection().keys(),s=[];await e.filters.toCollection().modify((e=>{const{id:a,accountId:n,path:i,filterValue:o}=e;if(!t.includes(n))return;const{include:r}=o;r&&r.forEach((e=>{1===e.length&&e[0].path===i&&(e.push({accountId:n}),s.push(a))}))})),s.length>0&&await e.filteringQueue.add({priority:R.Un.LOW,type:"RUN_FILTERS",filterIds:s})})),h.Z.version(110).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v110 mail: Import labels from other clients",5e3);const t=await e.searchList.toArray(),s=new _(110,"Upgrade v110 mail: Get new labels mails");s.total=t.length;const a=[],n=new Set;if(t.map((e=>{(0,O.OK)(e.flags)&&(a.push(e.id),(0,O.Q3)(e.flags).forEach((e=>{n.add(e)}))),s.count++})),s.stop(),n.size>0){const t=await e.filters.where("[accountId+path]").between([R.ut,""],[R.ut,"￿"]).toArray(),s=[...n].filter((e=>!t.some((t=>t.path===e)))),i={include:[]};if(s.length>0){const t=s.map((e=>{const t=[{flag:e}];return i.include.push(t),{accountId:R.ut,path:e,filterValue:{name:e,include:[t]}}}));v.U.setStatus(T.A4,`Upgrade v110 mail: Adding ${t.length} new labels`,5e3),await e.filters.bulkAdd(t);const n=t.map((e=>[e.accountId,e.path])),o=await e.filters.where("[accountId+path]").anyOf(n).primaryKeys(),r=I.Z.getAllViewTypes();o.forEach((t=>{r.forEach((s=>e.views.add({filterId:t,type:s})))})),await e.filters.where("[accountId+path]").equals([R.ut,R.ym]).modify((e=>{const{filterValue:t}=e;i.include&&(t.include?t.include=t.include.concat(i.include):t.include=i.include)})),m.Z.call({type:"RE_RUN_SLES",priority:R.Un.LOW,folderIds:[...t.map((e=>[e.accountId,e.path])),[R.ut,R.ym]],searchListIds:a})}}v.U.setStatus(T.A4,"Upgrade v110 mail: [Done] Import labels from other clients",5e3)})),h.Z.version(111).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v111 mail: Updating Junk filtering...",5e3);const t=await e.accounts.toArray(),s=new Map;t.forEach((e=>{const{accountId:t,folders:a}=e,n=new Map;s.set(t,n);Object.keys(a).forEach((e=>{a[e].forEach((t=>{n.set(t.path,e)}))}))})),await e.filters.toCollection().modify((e=>{const{accountId:t,path:a,filterValue:n}=e;if(n.include&&(n.include=n.include.map((e=>e.filter((e=>void 0===e.flag||"\\Junk"!==e.flag)))).filter((e=>e.length>0)),0===n.include.length&&delete n.include),n.exclude&&(n.exclude=n.exclude.map((e=>e.filter((e=>void 0===e.flag||"\\Junk"!==e.flag)))).filter((e=>e.length>0)),0===n.exclude.length&&delete n.exclude),t===R.of&&a===R.cm){if(n.exclude){n.exclude.some((e=>1===e.length&&e[0].folder===R.Hd))||n.exclude.push([{folder:R.Hd}])}else n.exclude=[[{folder:R.Hd}]];n.showJunkButton=!1}const i=s.get(t);i&&i.get(a)===R.Hd&&(n.include?function(e,t,s){return!!e.include&&e.include.some((e=>{let a=!1,n=!1;return 2===e.length&&(e.forEach((e=>{a=e.accountId===t||a,n=e.folder===s||n})),a&&n)}))}(n,t,R.Hd)||n.include.push([{accountId:t},{folder:R.Hd}]):n.include=[[{accountId:t},{folder:R.Hd}]])}))})),h.Z.version(112).upgrade((async e=>{const t=(await e.buffer.where("operation").equals("BUFFER_OPERATION_CUSTOM_FLAG").toArray()).filter((e=>e.flagUpdates.hasOwnProperty(R.T4.RECENT)));if(t.length>0){const s=t.map((e=>e._id));await e.buffer.where("_id").anyOf(s).modify((e=>{delete e.flagUpdates[R.T4.RECENT]}))}})),h.Z.version(113).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v113 mail: Adding counter to root folder of accounts",5e3);const t=(await e.accounts.toCollection().keys()).map((e=>[e,R.ym]));e.filters.where("[accountId+path]").anyOf(t).modify((e=>{e.filterValue.include&&e.filterValue.include.forEach(((t,s)=>{e.filterValue.include[s]=t.filter((e=>e.path!==R.ym))}))})),await e.filteringQueue.add({priority:R.Un.LOW,type:"RUN_FILTERS",folderIds:t,updateFilters:!0})})),h.Z.version(114).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v114 mail: Fixing empty root paths of Important/Feeds/Labels/Filters",5e3);const t=[];e.filters.where("[accountId+path]").anyOf([[R.Kz,R.ym],[R.u4,R.ym],[R.ut,R.ym],[R.wC,R.ym],[R.wC,R.W4],[R.wC,R.cs]]).modify((e=>{e.filterValue.include||(e.filterValue.include=[],t.push(e.id))}));const s=[[R.MN,R.ym],[R.MN,R.T4.RED],[R.MN,R.T4.ORANGE],[R.MN,R.T4.YELLOW],[R.MN,R.T4.GREEN],[R.MN,R.T4.BLUE],[R.MN,R.T4.PURPLE],[R.MN,R.T4.GRAY]];e.filteringQueue.add({priority:R.Un.LOW,type:"RUN_FILTERS",filterIds:t,folderIds:s,updateFilters:!0})})),h.Z.version(115).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v115 mail: Rerunning Labels/Flags filters since they we're updating correctly",5e3);const t=await e.filters.where("[accountId+path]").between([R.ut,""],[R.ut,"￿"]).primaryKeys(),s=[[R.ut,R.ym]];e.filteringQueue.add({priority:R.Un.LOW,type:"RUN_FILTERS",filterIds:t,folderIds:s,updateFilters:!0})})),h.Z.version(116).upgrade((async e=>{const t=new _(116,"Upgrade v116 mail: Re-allocating read/unread flags");t.total=await e.searchList.count();const s=await async function(){const t=[],s=await e.accounts.toArray();for(const e of s){const{accountId:s,folders:a}=e,n=a[R.Nz];if(n)for(const e of n)t.push([s,e.path])}const a=await e.filters.where("[accountId+path]").anyOf(t).primaryKeys();return new Set(a)}(),a=new Set;await e.searchList.toCollection().modify((e=>{const{id:n,flags:i,sources:o}=e,r=i.findIndex((e=>e===R.T4.SEEN)),c=r>=0;c&&i.splice(r,1);for(const[e,t]of o)s.has(e)?(t.read=!0,c||a.add(n)):t.read=c;t.count++})),m.Z.call({type:"RE_RUN_SLES",priority:R.Un.LOW,searchListIds:[...a]}),t.stop()})),h.Z.version(117).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v117 mail: Rerunning Labels/Flags filters since they we're updating correctly from other clients",5e3);const t=await e.filters.where("[accountId+path]").between([R.ut,""],[R.ut,"￿"]).primaryKeys(),s=[[R.ut,R.ym],[R.MN,R.ym],[R.MN,R.T4.RED],[R.MN,R.T4.ORANGE],[R.MN,R.T4.YELLOW],[R.MN,R.T4.GREEN],[R.MN,R.T4.BLUE],[R.MN,R.T4.PURPLE],[R.MN,R.T4.GRAY]];e.filteringQueue.add({priority:R.Un.LOW,type:"RUN_FILTERS",filterIds:t,folderIds:s})})),h.Z.version(118).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v118 mail: Deleting NonJunk from label (VB-70563)",5e3),await e.filters.where("[accountId+path]").equals([R.ut,"NonJunk"]).delete(),await e.filters.where("[accountId+path]").equals([R.ut,R.ym]).modify((e=>{if(e.filterValue.include){const t=e.filterValue.include;e.filterValue.include=t.filter((e=>e.some((e=>"NonJunk"!==e.flag))))}})),e.filteringQueue.add({priority:R.Un.LOW,type:"RUN_FILTERS",folderIds:[[R.ut,R.ym]]})})),h.Z.version(119).upgrade((async e=>{const t=new _(119,"Attachment count");t.total=await e.searchList.count(),await e.searchList.toCollection().modify((async e=>{e.attachment=e.attachment?2048:0,t.count++})),t.stop()})),h.Z.version(120).upgrade((async e=>{const t=new _(120,"Read mail should always be seen");t.total=await e.searchList.count(),await g.Z.initFilters(),await e.searchList.toCollection().modify((async e=>{e.unseen&&y.Z.call(e.sources)&&(e.unseen=!1),t.count++})),t.stop()})),h.Z.version(122).stores({buffer:["++_id","[accountId+path+operation]","accountId","[accountId+path]","operation","[accountId+destinationPath+operation]"].join(",")}).upgrade((async e=>{const t=new _(122,"Custom folders filtering"),s=(await e.filters.toCollection().primaryKeys()).map((e=>({filterId:e,type:R.js})));await e.views.bulkAdd(s);const a=await e.accounts.toArray(),n=I.Z.getAllViewTypes(),i=[];for(const t of a){const{accountId:s,folders:a}=t,o=a[R.Oi];if(o)for(const t of o){const{path:a}=t,o=I.Z.getDefaultCustomFolderFilter(s,a),r=await e.filters.add(o);for(const t of n)await e.views.add({filterId:r,type:t});i.push([o.accountId,o.path])}}await e.filteringQueue.add({type:"RUN_FILTERS",priority:R.Un.LOW,folderIds:i});const o=await e.searchList.toCollection().primaryKeys(),r=[];for(;o.length>0;)r.push({type:"RE_RUN_SLES",priority:R.Un.LOW,searchListIds:o.splice(0,1e4)});await e.filteringQueue.bulkAdd(r),t.stop()})),h.Z.version(123).upgrade((async e=>{const t=new _(123,'Undoing delete adds "unseen" label (VB-71009)');t.total=await e.searchList.count();const s=[];await e.searchList.filter((e=>e.flags.includes("unseen"))).modify((e=>{e.flags=e.flags.filter((e=>"unseen"!==e)),s.push(e.id),t.count++}));const a={unseen:!1},n=(await e.imap.where("searchListId").anyOf(s).toArray()).map((e=>{const{accountId:t,path:s,uid:n}=e;return{operation:"BUFFER_OPERATION_CUSTOM_FLAG",accountId:t,path:s,flagUpdates:a,uids:[n]}}));await e.buffer.bulkAdd(n);const i=await e.filters.where("[accountId+path]").equals([R.ut,"unseen"]).first();if(i){const t=await e.views.where("filterId").equals(i.id).toArray();await e.views.where("filterId").equals(i.id).delete();const a=new Set(t.map((e=>e.id)));await e.viewIds.where("searchListId").anyOf(s).modify((e=>e.viewIds=e.viewIds.filter((e=>!a.has(e))))),await e.filters.where("[accountId+path]").equals([R.ut,"unseen"]).delete(),await e.filters.where("[accountId+path]").equals([R.ut,R.ym]).modify((e=>{if(e.filterValue.include){const t=e.filterValue.include;e.filterValue.include=t.filter((e=>e.some((e=>"unseen"!==e.flag))))}})),await e.filteringQueue.add({priority:R.Un.LOW,type:"FILTERS_SLES",folderIds:[[R.ut,R.ym]],searchListIds:s})}t.stop()})),h.Z.version(124).upgrade((async e=>{const t=new _(124,"Move name from FilterValue to Filter");t.total=await e.filters.count(),await e.filters.toCollection().modify((e=>{e.name=e.filterValue.name,delete e.filterValue.name,t.count++})),t.stop()})),h.Z.version(125).upgrade((async e=>{e.filters.toCollection().modify((e=>{e.hasOwnProperty("hidden")&&delete e.hidden}))})),h.Z.version(126).upgrade((e=>{e.accounts.toCollection().modify((e=>{e.folders[R.Nz]||(e.folders[R.Nz]=[{name:R.N1,path:R.N1,delimiter:".",type:R.Nz}])}))})),h.Z.version(127).upgrade((async e=>{const t=await e.searchList.count(),s=new _(127,"New thread key");s.total=2*t;const a=new Map;await e.searchList.each((e=>{1===e.threadKey.length&&a.set(e.threadKey[0],e.id),s.count++})),await e.searchList.toCollection().modify((e=>{const t=e.threadKey.shift(),n=a.get(t),i=1e3*Math.floor(t/1e3);e.threadKey.unshift(n||0),e.threadKey.unshift(i),s.count++})),s.stop()})),h.Z.version(128).upgrade((async e=>{await e.filters.where("[accountId+path]").anyOf([[R.ut,"$Label1"],[R.ut,"$Label2"],[R.ut,"$Label3"],[R.ut,"$Label4"],[R.ut,"$Label5"],[R.ut,"$Label6"],[R.ut,"$Label7"]]).modify((e=>{switch(e.name){case"$Label1":e.name="Important";break;case"$Label2":e.name="Meeting";break;case"$Label3":e.name="Valuable";break;case"$Label4":e.name="To Do";break;case"$Label5":e.name="Send Reply";break;case"$Label6":e.name="Call Back";break;case"$Label7":e.name="Funny"}}))})),h.Z.version(129).upgrade((async e=>{const t=new _(128,"Parent Feeds view does not show mails (VB-46436)"),s=[R.u4,""],a=[R.u4,"￿"],n=[];await e.filters.where("[accountId+path]").between(s,a).modify((e=>{n.push(e.id),e.path===R.ym&&(e.filterValue.include=[[{accountId:R.u4}]]),e.filterValue.showFeeds=!0,e.filterValue.showDeletedButton=!0,e.filterValue.showMailingLists=!1,e.filterValue.showMailingListsButton=!1,e.filterValue.showJunkButton=!1,e.filterValue.showFeedsButton=!1,e.filterValue.showSubfolders=!1,e.filterValue.showCustomFolderButton=!1}));const i=[],o=await e.views.where("filterId").anyOf(n).toArray();t.total=o.length,o.forEach((e=>{"total"===e.type&&i.push(e.id),t.count++}));const r=await e.viewIds.where("viewIds").anyOf(i).primaryKeys();await e.filteringQueue.add({priority:R.Un.LOW,type:"FILTERS_SLES",folderIds:[[R.u4,R.ym]],searchListIds:r,updateFilters:!0}),t.stop()})),h.Z.version(130).upgrade((async e=>{v.U.setStatus(T.A4,"Upgrade v130 mail: Fetching message IDs...",5e3);const t=await e.searchList.toCollection().primaryKeys();for(t.reverse(),v.U.setStatus(T.A4,"Upgrade v130 mail: Requesting re-filtering...",5e3);t.length>0;){const s=t.splice(0,5e3);await e.filteringQueue.add({priority:R.Un.LOW,type:"RE_RUN_SLES",searchListIds:s})}v.U.setStatus(T.A4,"Upgrade v130 mail: Done",5e3)})),h.Z.version(131).upgrade((async e=>{const t=new _(131,"Upgrade v131 mail: Checking whether messages are showing up in all source folders");t.total=await e.searchList.count();const s=new Map;if(await e.searchList.toCollection().modify((e=>{const a=[...e.sources.keys()].filter((t=>!e.sourceFilterIds.includes(t)));if(a.length>0){const t=[...s.keys()].find((e=>e.length===a.length&&e.every((e=>a.includes(e)))));void 0!==t?s.get(t).push(e.id):s.set(a,[e.id])}t.count++})),t.stop(),s.size>0){const t=await e.accounts.toArray(),a=new Map;t.forEach((e=>{const{accountId:t,folders:s}=e,n=new Map;a.set(t,n);Object.keys(s).forEach((e=>{s[e].forEach((t=>{n.set(t.path,e)}))}))}));const n=new Map;s.forEach(((e,t)=>{t.forEach((e=>n.set(e,void 0)))}));(await e.filters.where("id").anyOf([...n.keys()]).toArray()).forEach((e=>{const t=a.get(e.accountId)?.get(e.path);switch(t){case R.Hd:n.set(e.id,[R.of,R.rp]);break;case R.uT:n.set(e.id,[R.of,R.cm]);break;case R.Oi:n.set(e.id,[R.Ry,e.accountId+"/"+e.path])}})),v.U.setStatus(T.A4,"Upgrade v131 mail: Adding filtering to source folders that need it",5e3),s.forEach(((t,s)=>{const a=[];s.forEach((e=>{const t=n.get(e);t&&!a.some((e=>e[0]===t[0]&&e[1]===t[1]))&&a.push(t)})),e.filteringQueue.add({priority:R.Un.LOW,type:"RE_RUN_SLES",searchListIds:t,filterIds:s,folderIds:a})}))}v.U.setStatus(T.A4,"Upgrade v131 mail: Done",5e3)})),h.Z.version(132).upgrade((async e=>{const t=[R.u4,""],s=[R.u4,"￿"],a=await e.filters.where("[accountId+path]").between(t,s).primaryKeys(),n=[U,"feed:"],i=[U,"feed:￿"],o=await e.filters.where("[accountId+path]").between(n,i).primaryKeys(),r=a.concat(o),c=await e.views.where("filterId").anyOf(r).primaryKeys();await e.views.where("id").anyOf(c).delete(),await e.filters.where("id").anyOf(r).delete();const d=await e.viewIds.where("viewIds").anyOf(c).primaryKeys();for(const t of[e.messages,e.searchList,e.threading,e.viewIds])await t.bulkDelete(d)})),h.Z.version(133).upgrade((async e=>{const t=new _(133,"Upgrade v132 mail: Update filter buttons"),s=await e.accounts.toArray(),a=new Map;s.forEach((e=>{const{accountId:t,folders:s}=e,n=new Map;a.set(t,n);Object.keys(s).forEach((e=>{s[e].forEach((t=>{n.set(t.path,e)}))}))})),t.total=await e.filters.count(),await e.filters.toCollection().modify((e=>{const{accountId:s,path:n,include:i,exclude:o,query:r,showMailingLists:c,showFeeds:d}=e.filterValue;let l=a.get(e.accountId)?.get(e.path);if(!l){if(l=e.accountId,e.accountId===R.of)switch(e.path){case R.ik:l=R.HM;break;case R.tB:l=R.yt;break;case R.N1:l=R.Nz;break;case R.Wb:l=R.kY;break;case R.J8:l=R.fZ;break;case R.rp:l=R.Hd;break;case R.cm:l=R.oV}[...a.keys()].includes(e.accountId)&&(l=R.e9)}const u=I.Z.getSearchListButtons(l),f={...s&&{accountId:s},...n&&{path:n},...i&&{include:i},...o&&{exclude:o},...r&&{query:r},...u,...u.showMailingListsButton&&"boolean"==typeof c&&{showMailingLists:c},...u.showFeedsButton&&"boolean"==typeof d&&{showFeeds:d}},h=new Set([R.of,R.ut,R.Kz,R.wC,R.u4]),p=new Set([R.MN,R.Ry,R.Sp]);function w(e,t){return!!e.exclude&&m(e.exclude,t,"flag")}function g(e,t){return!!e.exclude&&e.exclude.some((e=>e.some((e=>e.folder&&e.folder===t))))}function y(e,t,s){const a=e.exclude||[];m(a,t,s)?e.exclude=a.map((e=>e.filter((e=>e[s]!==t)))).filter((e=>e.length)):(a.push([{[s]:t}]),e.exclude=a)}function m(e,t,s){return e.some((e=>e.some((e=>!!e[s]&&e[s]===t))))}function L(e,t,s){return!!e.include&&e.include.some((e=>{let a=!1,n=!1;return 2===e.length&&(e.forEach((e=>{a=e.accountId===t||a,n=e.folder===s||n})),a&&n)}))}const v=function(e){const t={showDeleted:!0,showJunk:!0,showMailingLists:!0,showRead:!0,showFeeds:!0,showCustomFolder:!0,showArchived:!0,showSubFolders:!1};if(e&&e.filterValue){const{accountId:s,path:n,filterValue:i}=e;t.showRead=!w(i,R.T4.SEEN),t.showDeleted=!w(i,R.T4.DELETED),!function(e,t){return h.has(e)||t===R.ym&&(p.has(e)||a.has(e))}(s,n)?(t.showJunk=L(i,s,R.Hd),t.showArchived=L(i,s,R.hn)):(t.showJunk=!g(i,R.Hd),t.showCustomFolder=!g(i,R.Oi),t.showArchived=!g(i,R.hn)),void 0!==i.showMailingLists&&(t.showMailingLists=i.showMailingLists),void 0!==i.showFeeds&&(t.showFeeds=i.showFeeds),void 0!==i.showSubFolders&&(t.showSubFolders=i.showSubFolders)}return t}(e);function E(e,t,s,a){u[t]||!w(a,e)===s||function(e,t){y(e,t,"flag")}(a,e)}function Z(e,t,s,a){u[t]||!g(a,e)===s||function(e,t){y(e,t,"folder")}(a,e)}function b(t,s,a,n){u[s]||L(n,e.accountId,t)===a||function(e,t,s){let a=e.include||[],n=!1;a=a.filter((e=>{let a=!1,i=!1;return 2!==e.length||(e.forEach((e=>{a=e.accountId===t||a,i=e.folder===s||i})),n=a&&i,!n)})),n?e.include=a.length>0?a:[]:(a.push([{accountId:t},{folder:s}]),e.include=a)}(n,e.accountId,t)}E(R.T4.SEEN,"showReadButton",v.showRead,f),E(R.T4.DELETED,"showDeletedButton",v.showDeleted,f),Z(R.uT,"showDeletedButton",v.showDeleted,f),Z(R.Hd,"showJunkButton",v.showJunk,f),Z(R.Oi,"showCustomFolderButton",v.showCustomFolder,f),b(R.Hd,"showJunkButton",v.showJunk,f),b(R.uT,"showDeletedButton",v.showDeleted,f),e.filterValue=f,t.count++})),t.stop()})),h.Z.version(134).stores({imap:["[accountId+path+uid]","searchListId","[hasRaw+accountId+searchListId]","[accountId+path+searchListId]","accountId"].join(",")}),h.Z.version(135).upgrade((async e=>{const t=await e.accounts.toArray();for(const e of t)await f.Z.foldersToFilters(e.accountId,e.folders)})),h.Z.version(136).upgrade((async e=>{const t=new _(136,"Upgrade v136 mail: Fix emails that shouldn't be in trash (VB-73737)"),s=await e.accounts.toArray(),a=[];for(const e of s){const{accountId:t,folders:s}=e;s[R.uT]&&s[R.uT].forEach((e=>{e.type===R.uT&&e.subscribed&&a.push([t,e.path])}))}const n=await e.filters.where("[accountId+path]").anyOf(a).primaryKeys();t.total=await e.searchList.where("sourceFilterIds").noneOf(n).count();const i=new Map;await e.searchList.where("sourceFilterIds").noneOf(n).modify((e=>{e.sources.forEach(((t,s)=>{if(!t.internal&&t.deleted){t.internal=!0;const a=i.get(s);a?a.add(e.id):i.set(s,new Set([e.id]))}})),t.count++})),t.stop();const o=await e.filters.where("id").anyOf(i.keys()).toArray(),r=[];o.forEach((e=>{const t=i.get(e.id);t&&t.forEach((t=>{r.push([e.accountId,e.path,t])}))})),await e.imap.where("[accountId+path+searchListId]").anyOf(r).delete(),v.U.setStatus(T.A4,`Upgrade v136 mail: Found ${r.length} messages that should not be in trash`,5e3)}));const P=new Map;h.Z.version(137).stores({_upgrades:"version"}),P.set(137,(async e=>{new _(137,"Upgrade v137 mail").stop()})),P.set(138,(async e=>{const t=new _(138,"Upgrade v138 mail: Run Custom Folder");await e.filteringQueue.add({priority:R.Un.LOW,type:"RUN_FILTERS",folderIds:[[R.Ry,R.ym]],updateFilters:!0}),t.stop()})),P.set(139,(async e=>{const t=new _(139,"Upgrade v139 mail: Repair default filters"),s=[],a=["total","unseen","unread","excludeMailingLists","excludeDeleted","excludeRssFeeds","excludeJunk","excludeCustomFolders"];for(const t of Z.j){const{accountId:n,path:i}=t,o=await e.filters.where("[accountId+path]").equals([n,i]).first();if(o){const{id:n}=o,i={id:n,...t};await e.filters.put(i);const r=await e.views.where("filterId").equals(n).toArray(),c=new Set(r.map((e=>e.type)));for(const t of a)if(!c.has(t)){const s={filterId:n,type:t};e.views.add(s)}s.push(n)}else{const n=await e.filters.add(t);for(const t of a)await e.views.add({filterId:n,type:t});s.push(n)}}if(s.length>0){const t={priority:R.Un.LOW,type:"RUN_FILTERS",filterIds:s};e.filteringQueue.add(t)}t.stop()})),P.set(140,(async e=>{const t=new _(140,"Map viewIds to new format");t.total=await e.viewIds.count()+await e.views.count();const s=new Map,a=["total","unseen","unread","excludeMailingLists","excludeDeleted","excludeRssFeeds","excludeJunk","excludeCustomFolders"];await e.views.each((e=>{const n=a.indexOf(e.type);-1!==n&&s.set(e.id,100*e.filterId+n),t.count++})),await e.viewIds.toCollection().modify((e=>{const a=new Set;e.viewIds.forEach((e=>{const t=s.get(e);"number"==typeof t&&a.add(t)})),e.viewIds=[...a],t.count++})),e.views.clear(),t.stop()})),h.Z.version(141).stores({deletedFeedItems:"++id,path"}),P.set(142,(async e=>{const t=new _(142,"Fixing default parent filters");let s,a,n,i,o,r;function c(e,t){const{include:s}=e.filterValue;for(const e of t){s.some((t=>(0,M.default)(t,e)))||s.push(e)}}r=[R.wC,""],o=[R.wC,"￿"];const d=await e.filters.where("[accountId+path]").between(r,o).toArray(),l=[],u=[];for(const e of d){const{path:t,filterValue:i}=e;if(t===R.ym)s=e;else if(t===R.W4)a=e;else if(t===R.cs)n=e;else{const e=i.include.filter((e=>1===e.length&&(e[0].listId||e[0].senderIsMailingList)));t.startsWith(R.W4)?l.push(...e):t.startsWith(R.cs)&&u.push(...e)}}if(!s)throw new Error("Mailing list root folder not found");if(!a)throw new Error("Mailing list Important folder not found");if(!n)throw new Error("Mailing list Other folder not found");c(s,l),c(s,u),c(a,l),c(n,u),r=[R.ut,""],o=[R.ut,"￿"];const f=await e.filters.where("[accountId+path]").between(r,o).toArray(),h=[];for(const e of f){const{path:t,filterValue:s}=e;if(t===R.ym)i=e;else{const e=s.include.filter((e=>1===e.length&&e[0].flag));h.push(...e)}}if(!i)throw new Error("Labels root folder not found");c(i,h),await e.filters.bulkPut([s,a,n,i]);const p=[s.id,a.id,n.id,i.id];await g.Z.updateFilters(p),await m.Z.call({type:"RUN_FILTERS",priority:R.Un.LOW,filterIds:p}),t.stop()})),P.set(143,(async e=>{const t=new _(143,"Fixing database inconsistency"),s=await e.searchList.toCollection().primaryKeys(),a=await e.viewIds.toCollection().primaryKeys(),n=new Set(s),i=a.filter((e=>!n.has(e)));await e.viewIds.where("searchListId").anyOf(i).delete(),t.stop()})),h.Z.version(144).stores({viewIds:"searchListId"}),P.set(146,(async e=>{const t=new _(146,"Fixing state of show-read button in received folder");await e.filters.where("[accountId+path]").equals([R.of,R.ik]).modify((e=>{e.filterValue={...e.filterValue,showReadButton:!0}})),t.stop()})),h.Z.version(147).stores({mailingList:"listId"}),P.set(147,(async e=>{const t=new _(147,"Group mailing lists providers (like xt.local and sparkpostmail.com)");await e.mailingList.bulkAdd(b);const s=R.wC,a=[s,""],n=[s,"￿"],i=await e.filters.where("[accountId+path]").between(a,n).toArray(),o=[];if(i.forEach((e=>{(e.path.endsWith(".xt.local")||e.path.endsWith(".sparkpostmail.com")||e.path.endsWith("list-id.mcsv.net")||e.path.startsWith(R.cs+"/spc-")||e.path.startsWith(R.W4+"/spc-"))&&o.push(e.id)})),o.length>0){const s=o.map((e=>100*e));await e.filters.where("id").anyOf(o).delete();const a=new Set,n=8;t.total=s.length,s.forEach((e=>{for(let t=0;t<n;t++)a.add(e+t)}));const i=[];await e.viewIds.toCollection().modify((e=>{const s=e.viewIds.filter((e=>!a.has(e)));s.length!==e.viewIds&&(i.push(e.searchListId),e.viewIds=s),t.count++})),await e.filteringQueue.add({priority:R.Un.LOW,type:"RE_RUN_SLES",searchListIds:i,runMailingLists:!0,updateFilters:!0})}t.stop()})),P.set(148,(async e=>{const t=new _(148,"VB-78846: Rerun views for flags and labels"),s=[R.ut,""],a=[R.ut,"￿"],n=await e.filters.where("[accountId+path]").between(s,a).primaryKeys(),i=[R.MN,""],o=[R.MN,"￿"],r=await e.filters.where("[accountId+path]").between(i,o).primaryKeys();await e.filteringQueue.add({priority:R.Un.LOW,type:"RUN_FILTERS",filterIds:[...n,...r]}),t.stop()})),h.Z.version(149).stores({systemTasks:"++id",tokens:null}),P.set(149,(async e=>{const t=new _(149,"Clear tokens table and prepare for transition to new search db ...");await e.systemTasks.add({taskName:"restore_full_text_search_db",currentPosition:0}),t.stop()})),P.set(150,(async e=>{const t=new _(150,"VB-79158: [Mail] Unseen/Read status does not always match changes done with external server"),s=await e.accounts.toArray(),a=[];for(const e of s){const{accountId:t,folders:s}=e;for(const e in s)s[e].forEach((e=>{a.push([t,e.path])}))}const n=await e.filters.where("[accountId+path]").anyOf(a).toArray(),i=new Set;await e.searchList.toCollection().modify((e=>{const t=[...e.sources].filter((([e,t])=>t.internal)),s=[...e.sources].filter((([e,t])=>!t.internal));t&&0!==t.length&&s&&0!==s.length&&s.forEach((([s,a])=>{const o=n.find((e=>e.id===s))?.accountId;o&&t.forEach((([t,s])=>{const r=n.find((e=>e.id===t))?.accountId;if(r&&r===o){const s=e.sources.get(t);s&&s.read!==a.read&&(s.read=a.read,i.add(e.id),s.read&&(e.unseen=!1))}}))}))})),await e.filteringQueue.add({priority:R.Un.LOW,type:"RE_RUN_SLES",searchListIds:[...i]}),t.stop()})),P.set(151,(async e=>{const t=new _(151,"Removing orphan source-filter IDs");t.total=await e.searchList.count();const s=await e.filters.toCollection().primaryKeys(),a=new Set(s);await e.searchList.toCollection().modify((e=>{e.sourceFilterIds=e.sourceFilterIds.filter((e=>a.has(e)));const s=new Map;for(const[t,n]of e.sources)a.has(t)&&s.set(t,n);e.sources=s,t.count++})),t.stop()})),P.set(152,(async e=>{const t=new _(152,"Resetting feed data for updating paths"),s=await w.Z.waitFor((()=>l.Z.prefs.get(F.kRssSettings)));if(0===s.length)return void t.stop();const a={},n=[];t.total=s.length;for(const i of s){const s=await e.filters.where("[accountId+path]").equals([R.u4,i.path]).first();if(a[i.path])try{const t={accountId:R.u4,filterValue:{exclude:a[i.path].filterValue.exclude.slice(),include:[[{accountId:R.u4},{path:i.url}]],showCustomFolderButton:!1,showFeedsButton:!1,showJunkButton:!1,showMailingListsButton:!1},name:i.title,path:i.url},s=await e.filters.add(t);n.push(s)}catch(e){console.error(e)}else if(s){a[i.path]=s;const t={...s.filterValue,include:[[{accountId:R.u4},{path:i.url}]]};await e.filters.update(s.id,{path:i.url,filterValue:t}),n.push(s.id)}else console.error("Filter not found for feed path",i.path);i.path=i.url,t.count++}l.Z.prefs.set({path:"vivaldi.rss.settings",value:s}),await m.Z.call({type:"RUN_FILTERS",priority:R.Un.LOW,filterIds:n}),t.stop()})),P.set(153,(async e=>{const t=new _(153,"Re-run sender is a mailing list filters"),s=await e.filters.where("[accountId+path]").between([R.wC,""],[R.wC,"￿"]).filter((e=>e.filterValue.include?.some((e=>e.some((e=>!!e.senderIsMailingList)))))).primaryKeys();await m.Z.call({type:"RUN_FILTERS",priority:R.Un.LOW,filterIds:s}),t.stop()})),P.set(154,(async e=>{const t=new _(154,"Fix unseen counters");t.total=await e.searchList.count();const s=[];await g.Z.initFilters(),await e.searchList.toCollection().modify((e=>{e.unseen&&y.Z.call(e.sources)&&(e.unseen=!1,s.push(e.id)),t.count++})),await e.filteringQueue.add({priority:R.Un.LOW,type:"RE_RUN_SLES",searchListIds:s}),t.stop()})),P.set(158,(async e=>{const t=new _(158,"Update thread key");t.total=await e.searchList.count(),await e.searchList.toCollection().modify((e=>{0===e.threadKey[1]&&(e.threadKey[1]=e.id),t.count++})),t.stop()})),P.set(159,(async e=>{const t=new _(159,"Update old filter rules and delete contact filters"),s=await e.filters.where("[accountId+path]").between([R.wC,""],[R.wC,"￿"]).count()+await e.filters.where("[accountId+path]").between([R.Kz,""],[R.Kz,"￿"]).count(),a=[U,""],n=[U,"￿"],i=await e.filters.where("[accountId+path]").between(a,n).primaryKeys(),o=await e.filters.where("[accountId+path]").equals([R.Kz,R.ym]).primaryKeys();if(i.push(...o),i.length>0){const a=100,n=i.map((e=>e*a));await e.filters.where("id").anyOf(i).delete();const o=new Set,r=8;n.forEach((e=>{for(let t=0;t<r;t++)o.add(e+t)})),t.total=await e.viewIds.count()+s,await e.viewIds.toCollection().modify((e=>{const s=e.viewIds.filter((e=>!o.has(e)));s.length!==e.viewIds&&(e.viewIds=s),t.count++}))}else t.total=s;function r(e,t,s,a,n){e||(e="");let i=s;return a.includes("equal")&&["subject"].includes(t)&&(i=`"${i}"`),"anywhere"!==t&&(i=`${t}:${i}`),n&&e&&(i=`${e?" ":""}${n} `+i),e?e+i:i}const c=(e,t)=>{const s=[...e.filterValue[t]].filter(((s,a)=>{const n=[...s].filter(((s,a)=>{for(const n in s){let i="";const o="exclude"===t?"NOT":a?"AND":"OR";return"subject"!==n&&"to"!==n&&"from"!==n&&"cc"!==n||(i="subject"===n?s[n]:s[n].address,e.filterValue.query=r(e.filterValue.query,n,i,"equal",o),!1)}}));return e.filterValue[t][a]=n,0!==n.length}));0===s.length?delete e.filterValue[t]:e.filterValue[t]=s},d=e=>{e.filterValue.include&&c(e,"include"),e.filterValue.exclude&&c(e,"exclude")};await e.filters.where("[accountId+path]").between([R.wC,""],[R.wC,"￿"]).modify((e=>{d(e),t.count++})),await e.filters.where("[accountId+path]").between([R.Kz,""],[R.Kz,"￿"]).modify((e=>{e.path===R.ym?(e.filterValue.include=[],e.filterValue.exclude&&delete e.filterValue.exclude):d(e),t.count++})),t.stop()})),P.set(160,(async e=>{const t=new _(160,"Update viewIds of messages that have too many unseen counters"),s=[];await e.searchList.toArray().then((e=>{e.forEach((e=>{e.unseen||s.push(e.id)}))})),t.total=s.length,await e.viewIds.where("searchListId").anyOf(s).modify((e=>{e.viewIds=e.viewIds.filter((e=>!function(e){return e%100==1}(e))),t.count++})),t.stop()})),P.set(161,(async e=>{const t=new _(161,"Update Received folder to include send to self"),s={name:R.ik,accountId:R.of,path:R.ik,filterValue:{include:[[{folder:"Archive"}],[{folder:"Flagged"}],[{folder:R.Oi}],[{folder:R.e9}],[{folder:R.Hd}],[{folder:R.uT},{folder:"Not Sent Internal"}]],...I.Z.getSearchListButtons(R.HM)}};s&&(await e.filters.where("[accountId+path]").equals([s.accountId,s.path]).modify((e=>{e.filterValue.include=s.filterValue.include,e.filterValue.exclude=e.filterValue.exclude.filter((e=>!e.some((e=>e.folder===R.Nz))))})),await m.Z.call({priority:R.Un.LOW,type:"RUN_FILTERS",folderIds:[[R.of,R.ik]]})),t.stop()})),h.Z.version(162).stores({filteringQueue:"++id"}),P.set(163,(async e=>{const t=new _(163,"Adding support for Archive folders"),s="Archive",a="Archive",n=new Map;await e.accounts.toCollection().modify((({accountId:e,folders:t})=>{const i=t.Other;if(!i)return;const o=[];if(t.Other=i.filter((e=>{const{name:t,path:n}=e;return t!==a&&n!==a||(o.push({...e,type:s}),!1)})),o.length>0){const e=t.Archive;e?e.push(...o):t.Archive=o}const r=new Map;n.set(e,r);Object.keys(t).forEach((e=>{t[e].forEach((t=>{r.set(t.path,e)}))}))}));let i=!1;await e.filters.toCollection().modify((e=>{const{accountId:t,path:s,filterValue:a}=e;"All Messages"===t&&"Archive"===s&&(i=!0);const o=function(e,t){const s=n.get(e)?.get(t);return s||(e===R.of&&t===R.rp?R.Hd:t)}(t,s);if((["Sent","Drafts","Outbox"].includes(o)||["Single thread","Feeds"].includes(t))&&(a.showArchivedButton=!1),"Archive"===o){const e=[{accountId:t},{folder:"Archive"}];a.include?a.include.push(e):a.include=[e],a.showCustomFolderButton=!1,a.showJunkButton=!1,a.showArchivedButton=!1}})),i||(await e.filters.add({name:"Archive",accountId:"All Messages",path:"Archive",filterValue:{include:[[{folder:"Archive"}]],exclude:[[{flag:"\\Deleted"}],[{folder:"Trash"}]],showCustomFolderButton:!1,showJunkButton:!1,showArchivedButton:!1}}),await e.filteringQueue.add({priority:15,type:"RE_RUN_SLES",folderIds:[["All Messages","Archive"]],runMailingLists:!0})),t.stop()})),P.set(164,(async e=>{const t=new _(164,"Update names for filters");e.filters.toCollection().modify((e=>{e.name===R.ym&&(e.name=e.accountId)})),t.stop()})),P.set(165,(async e=>{const t=new _(165,"Fix Archive status in filters"),s=new Map;function a(e,t){return e.some((e=>1===e.length&&e[0]?.folder===t))}await e.accounts.each((({accountId:e,folders:t})=>{const a=new Map;s.set(e,a);Object.keys(t).forEach((e=>{t[e].forEach((t=>{a.set(t.path,e)}))}))})),await e.filters.toCollection().modify((e=>{const{accountId:t,path:n,filterValue:i}=e,o=function(e,t){const a=s.get(e)?.get(t);return a||(e===R.of&&t===R.rp?R.Hd:t)}(t,n);if("Archive"===o){delete i.showJunkButton;const e=[{folder:"Junk"}];i.exclude?a(i.exclude,"Junk")||i.exclude.push(e):i.exclude=[e]}else if(!1!==i.showArchivedButton){const e=[{folder:"Archive"}];i.exclude?a(i.exclude,"Archive")||i.exclude.push(e):i.exclude=[e]}})),t.stop()})),P.set(166,(async e=>{const t=new _(166,"Apply default showSubFolders and clear related include rules"),s=new Set(["Custom Folders","Mailing Lists","Filters","Labels","Flags","Feeds"]),a=new Set(["Other Mailing Lists","Important Mailing Lists"]),n=await e.accounts.toCollection().primaryKeys(),i=new Map,o=new Set;await e.filters.toCollection().modify((e=>{const{id:t,accountId:r,path:c,filterValue:d}=e;"VIVALDI_RESERVED_DUMMY_ROOT_PLACEHOLDER_PATH"===c&&(s.has(r)||n.includes(r))?(d.include=[],d.showSubFolders=!0,o.add(t)):"Mailing Lists"===r&&(a.has(c)?(d.include=[],d.showSubFolders=!0,o.add(t)):i.set(c,e))}));for(const e of[...i.values()]){const{include:t}=e.filterValue;if(!t||0===t.length)continue;const s=new Set;for(const e of t)for(const t of e)t.listId&&s.add(t.listId);if(0===s.size)continue;let a=e.path.substring(0,e.path.lastIndexOf("/")),n=i.get(a);for(;n;){const{id:e,filterValue:t}=n;if(t.include?.length>0){const a=t.include.length;t.include=t.include.filter((e=>!e.some((e=>s.has(e.listId))))),t.include.length<a&&o.add(e)}t.showSubFolders=!0,a=a.substring(0,a.lastIndexOf("/")),n=i.get(a)}}i.size>0&&await e.filters.bulkPut([...i.values()]),o.size>0&&await e.filteringQueue.add({priority:R.Un.LOW,type:"RUN_FILTERS",filterIds:[...o]}),t.stop()})),P.set(167,(async e=>{const t=new _(167,"Fix filter include rules"),s=[],a=new Set(["Flags","Custom Folders","All Accounts"]),n=await e.accounts.toCollection().primaryKeys(),i=new Set(n);await e.filters.toCollection().modify((e=>{const{id:t,accountId:n,path:o,filterValue:r}=e;"VIVALDI_RESERVED_DUMMY_ROOT_PLACEHOLDER_PATH"===o&&(a.has(n)&&(!r.include||r.include.length>0)&&(r.include=[],s.push(t)),!r.include&&i.has(n)&&(r.include=[],s.push(t)))})),s.length>0&&await e.filteringQueue.add({priority:15,type:"RUN_FILTERS",filterIds:s}),t.stop()})),P.set(170,(async e=>e.buffer.where("operation").equals("BUFFER_OPERATION_REMOVE_ACCOUNT_PATH").filter((e=>void 0===e.path)).delete())),P.set(171,(async e=>{await e.filteringQueue.toCollection().modify((e=>{if(e.folderIds){Array.isArray(e.folderIds[0])||(e.folderIds=[e.folderIds]);for(const t of e.folderIds)t[1]=t[1]||"VIVALDI_RESERVED_DUMMY_ROOT_PLACEHOLDER_PATH"}}))})),P.set(173,(async e=>{const t=new _(173,"Fix casing of inbox and remove duplicates if found"),s=await e.accounts.toArray();for(const t of s){if(t.accountId===R.of){await e.accounts.delete(R.of);continue}const s=t.folders.Inbox||[];for(const a of s)"inbox"===a.path.toLowerCase()&&"Inbox"!==a.path&&(a.path="Inbox",await e.accounts.update(t.accountId,t))}function a(e){let t=!1;"inbox"===e.path.toLowerCase()&&"Inbox"!==e.path&&(e.path="Inbox",t=!0);for(const s of["include","exclude"])if(e.filterValue[s])for(const a of e.filterValue[s])for(const e of a)e.path&&"inbox"===e.path.toLowerCase()&&"Inbox"!==e.path&&(e.path="Inbox",t=!0);return t}const n=await e.filters.toArray(),i=n.filter((e=>"inbox"===e.path.toLowerCase())),o={};for(const e of i)o[e.accountId]?o[e.accountId].push(e):o[e.accountId]=[e];for(const s in o){const n=(await e.imap.where("accountId").equals(s).toArray()).filter((e=>"inbox"===e.path.toLowerCase())),i=new Map;t.total=n.length,t.count=0;for(const s of n){t.count++;const{accountId:a,path:n,uid:o}=s,r=i.get(o);r?0===r.hasRaw&&1===s.hasRaw&&(r.hasRaw=1):i.set(o,{...s,path:"Inbox"}),"Inbox"!==n&&await e.imap.delete([a,n,o])}await e.imap.bulkPut(Array.from(i.values()));const r=(await e.mailboxCache.where("accountId").equals(s).toArray()).filter((e=>"inbox"===e.path.toLowerCase())),c=new Map;t.total=r.length,t.count=0;for(const s of r){t.count++;const{accountId:a,path:n}=s,i=c.get(n);i?(Number(s.highestModseq)>Number(i.highestModseq)&&(i.highestModseq=s.highestModseq),s.uidNext>i.uidNext&&(i.uidNext=s.uidNext),s.exists>i.exists&&(i.exists=s.exists)):c.set(n,{...s,path:"Inbox"}),await e.mailboxCache.delete([a,n])}await e.mailboxCache.bulkPut(Array.from(c.values()));const d=await e.buffer.where("accountId").equals(s).toArray();t.total=d.length,t.count=0;for(const s of d){t.count++;const{_id:a,path:n="",destinationPath:i=""}=s;"inbox"===n.toLowerCase()&&"Inbox"!==n&&await e.buffer.update(a,{path:"Inbox"}),i&&"inbox"===i.toLowerCase()&&"Inbox"!==i&&await e.buffer.update(a,{destinationPath:"Inbox"})}const l=await e.filteringQueue.toArray();t.total=l.length,t.count=0;for(const s of l){t.count++;let a=!1;const{id:n,folderIds:i,fromFolderId:o,toFolderId:r}=s;if(i)for(const e of i)"inbox"===e[1].toLowerCase()&&"Inbox"!==e[1]&&(e[1]="Inbox",a=!0);o&&"inbox"===o[1].toLowerCase()&&"Inbox"!==o[1]&&(o[1]="Inbox",a=!0),r&&"inbox"===r[1].toLowerCase()&&"Inbox"!==r[1]&&(r[1]="Inbox",a=!0),a&&await e.filteringQueue.update(n,s)}const u=o[s];if(1===u.length){const t=u[0];a(t)&&await e.filters.update(t.id,t)}else if(u.length>1){let s=u.find((e=>"Inbox"===e.path));s||(s=u[0],a(s)&&await e.filters.update(s.id,s));const n=u.filter((e=>e.id!==s.id)),i=n.map((e=>e.id)),o=n.map((e=>100*e.id));await e.filters.where("id").anyOf(i).delete();const r=new Set,c=9;t.total=o.length,t.count=0,o.forEach((e=>{for(let t=0;t<c;t++)r.add(e+t)})),await e.viewIds.toCollection().modify((e=>{const s=e.viewIds.filter((e=>!r.has(e)));s.length!==e.viewIds&&(e.viewIds=s),t.count++}))}}const r=n.filter((e=>"inbox"!==e.path.toLowerCase()));t.total=r.length,t.count=0;for(const s of r)t.count++,a(s)&&await e.filters.update(s.id,s);t.stop()})),P.set(174,(async e=>{const t=new _(174,"Delete empty label if there is one"),s=await e.filters.where("[accountId+path]").equals([R.ut,""]).primaryKeys(),a=[0,1,2,3,4,5,6,7,8];if(s.length>0)for(const n of s){t.total=await e.viewIds.count();const s=100,i=new Set(a.map((e=>n*s+e)));await e.viewIds.toCollection().modify((e=>{const s=e.viewIds.filter((e=>!i.has(e)));s.length!==e.viewIds&&(e.viewIds=s),t.count++})),e.filters.delete(n)}t.stop()})),P.set(175,(async e=>{const t=new _(175,"Re-run filtering"),s=new Map;await e.searchList.each((({id:e,sourceFilterIds:a})=>{for(const t of a){const a=s.get(t);a?a.push(e):s.set(t,[e])}t.count++}));for(const[t,a]of s)await e.filteringQueue.add({type:"FILTERS_SLES",priority:20,searchListIds:a,filterIds:[t],runAllMessages:!0,runMailingLists:!0,runCustomFolders:!0,runFlagFolders:!0,runLabels:!0,runQueries:!0,runSingleThread:!0})})),P.set(176,(async e=>{const t=new _(176,"Fix grouped mailing lists"),s=await e.mailingList.toArray(),a=await e.filters.where("[accountId+path]").between(["Mailing Lists",""],["Mailing Lists","￿"]).filter((e=>{const{path:t}=e,a=t.indexOf("/");if(a<0)return!1;const n=t.substring(a+1);return!n.includes("/")&&s.some((({listId:e,parentFolderType:t})=>{switch(t){case"endsWith":return n.endsWith(e);case"startsWith":return n.startsWith(e);case"matches":return n===e}}))})).primaryKeys();if(0===a.length)return;await e.filters.bulkDelete(a);const n=new Set;for(const e of a)for(let t=0;t<9;t++)n.add(100*e+t);t.total=await e.viewIds.count(),await e.viewIds.toCollection().modify((e=>{const s=e.viewIds.filter((e=>!n.has(e)));s.length<e.viewIds.length&&(e.viewIds=s),t.count++})),await e.filteringQueue.add({priority:20,type:"RE_RUN_SLES",runMailingLists:!0}),t.stop()})),P.set(177,(async e=>{const t=new _(177,"Add default labels"),s=(0,E.Z)(Z.j).filter((e=>e.accountId===R.ut)),a=await e.filters.where("[accountId+path]").between([R.ut,""],[R.ut,"￿"]).toArray(),n=s.filter((e=>!a.some((t=>t.path===e.path))));n.length>0&&await e.filters.bulkAdd(n),t.stop()})),P.set(178,(async e=>{const t=new _(178,"Delete empty label actions");await e.filters.where("[accountId+path]").between([R.Kz,""],[R.ut,"￿"]).modify((e=>{e.triggers&&(e.triggers=e.triggers.filter((e=>void 0===e.label||""!==e.label)))})),t.stop()})),P.set(179,(async e=>{const t=new _(179,"Fixing saved searches"),s=["Filters",""],a=["Filters","￿"],n=await e.accounts.toCollection().primaryKeys();if(n.length>0){const t="VIVALDI_RESERVED_DUMMY_ROOT_PLACEHOLDER_PATH",i=n.map((e=>[e,t])),o=(e,t)=>{const{filterValue:s}=e;if(s.showSubFolders){delete s.showSubFolders;const e=s.include||[];s.include=[...e,[{accountId:t}]]}};await e.filters.where("[accountId+path]").anyOf(i).modify((e=>o(e,e.accountId))),await e.filters.where("[accountId+path]").between(s,a).filter((e=>{const{selectedAccountId:t,selectedName:s}=e;return t===s&&n.includes(t)})).modify((e=>{const{selectedAccountId:t,accountId:s,path:a}=e;o(e,t),i.push([s,a])})),await e.filteringQueue.add({type:"RUN_FILTERS",priority:15,folderIds:i})}const i=await e.filters.toArray(),o=await e.filters.where("[accountId+path]").between(s,a).filter((({filterValue:e,selectedAccountId:t,selectedName:s})=>{if(e.showSubFolders)return!0;if(t&&s){if(!i.some((e=>e.accountId===t&&e.name===s)))return!0}return!1})).primaryKeys();if(o.length>0){await e.filters.bulkDelete(o);const s=new Set;for(const e of o)for(let t=0;t<9;t++)s.add(100*e+t);t.total=await e.viewIds.count(),await e.viewIds.toCollection().modify((e=>{const a=e.viewIds.filter((e=>!s.has(e)));a.length<e.viewIds.length&&(e.viewIds=a),t.count++}))}t.stop()})),P.set(180,(async e=>{const t=new _(180,"Decode imap folder filter names"),s=await e.accounts.toCollection().primaryKeys();await e.filters.toCollection().modify((e=>{s.includes(e.accountId)&&(e.name=(0,S.kF)(e.name))})),t.stop()})),P.set(181,(async e=>{const t=new _(181,"Adding labels made from webmail");const s=[R.ut,""],a=[R.ut,"￿"],n=(await e.filters.where("[accountId+path]").between(s,a).toArray()).map((e=>e.path)),i=new Set,o=new Set,r=await e.searchList.toArray();if(t.total=r.length,r.forEach((e=>{e.flags.forEach((t=>{!n.includes(t)&&function(e){const t=e.toLowerCase();return t.startsWith("$label")||"$"!==t[0]&&"\\"!==t[0]&&!["mdnsent","forwarded","submitpending","submitted","junk","notjunk","nonjunk","phishing","important","draft","seen","flagged","answered","recent"].includes(t)}(t)&&(i.add(t),o.add(e))})),t.count++})),[...i].length>0){const t=[...i].map((e=>{const t=[{flag:e}];return{name:e,accountId:R.ut,path:e,filterValue:{include:[t],...I.Z.getSearchListButtons(R.ut)}}})),s=await e.filters.bulkAdd(t,{allKeys:!0});m.Z.call({type:"RE_RUN_SLES",priority:R.Un.LOW,folderIds:[[R.ut,R.ym]],filterIds:s,searchListIds:[...o].map((e=>e.id))})}t.stop()})),P.set(182,(async e=>{const t=new _(182,"Refactor filter view toggles");t.total=await e.filters.count(),await e.filters.toCollection().modify((e=>{const{accountId:s,filterValue:a}=e;a.exclude&&(a.exclude=a.exclude.filter((t=>{for(const s of t)return s.flag===R.T4.SEEN?(e.filterValue.showRead=!1,!1):s.flag===R.T4.DELETED||s.folder===R.uT?(e.filterValue.showDeleted=!1,!1):s.folder===R.Hd?(e.filterValue.showJunk=!1,!1):s.folder===R.Oi?(e.filterValue.showCustomFolder=!1,!1):s.folder!==R.hn||(e.filterValue.showArchived=!1,!1)})),0===a.exclude.length&&delete a.exclude),a.include&&(a.include=a.include.filter((t=>{let a=!1,n=!1,i=!1;return 2!==t.length||(t.forEach((e=>{a=e.accountId===s||a,n=e.folder===R.Hd||n,i=e.folder===R.hn||i})),a&&n?(e.filterValue.showJunk=!0,!1):!a||!i||(e.filterValue.showArchived=!0,!1))}))),t.count++})),t.stop()})),h.Z.version(183).stores({importStatus:null,importProgress:"path"}),P.forEach(((e,t)=>h.Z.version(t).upgrade((async s=>{try{await e(s),await s._upgrades.add({version:t})}catch(e){throw u.ZP.error("Mail",["Upgrade",""+t],e),e}})))),h.Z.on("ready",(async()=>{const e=await h.Z._upgrades.toCollection().last();let t=[...P.keys()];e&&(t=t.filter((t=>t>e.version))),t.sort(((e,t)=>e-t));for(const e of t){const t=P.get(e);t&&await h.Z.transaction("rw",h.Z.tables,(s=>t(s).then((()=>s._upgrades.add({version:e})))))}}));const N=h.Z;var C=s(95095);let x={level:0,children:new Map};const k={data:new Map,add:e=>{void 0!==e.id&&k.data.set(e.id,e)},async get(e){const t=k.data.get(e);if(t)return t;{const t=await h.Z.threading.get(e);if(!t)return;const s={id:t.id,messageId:t.messageId};return k.add(s),s}},clear:()=>{k.data.clear()}};function D(){k.clear()}function V(e){e.forEach((e=>{const{id:t,messageId:s}=e,a={id:t,messageId:s};k.add(a)}))}function $(e){const{inReplyTo:t,references:s}=e,a=[...s];return t&&!a.includes(t)&&a.push(t),a.reduce(((e,t)=>e.then((e=>j(t).then((s=>{if(s)return s;{const s={messageId:t},a=Q(void 0,e);return B(s,a).then((()=>a))}}))))),Promise.resolve()).then((t=>{const{id:s,sentDate:a,messageId:n,outbound:i}=e,o={id:s,messageId:n};return j(n).then((e=>{if(e)return e.sentDateById.has(s)?(e.sentDateById.set(s,a),e):(e.sentDateById.set(s,a),B(o,e).then((()=>e)));{const e=Q({id:s,sentDate:a,outbound:i},t);return B(o,e).then((()=>e))}}))}))}function B(e,t,s=x){if(s.threadNode)return Promise.resolve().then((()=>{if(void 0!==s.id)return k.get(s.id).then((t=>{if(t&&t.messageId!==e.messageId)return{id:t.id,messageId:t.messageId}}));if(void 0!==s.messageId){if(s.messageId!==e.messageId)return{messageId:s.messageId};void 0!==e.id&&(s.id=e.id,delete s.messageId)}})).then((n=>{if(!n)return;const i=s.parent,o={children:new Map,level:i.level+1},r=e.messageId.substr(2*i.level,2);i.children.set(r,o);const c=s.threadNode,d=n.messageId.substr(2*o.level,2),l=e.messageId.substr(2*o.level,2);if(d!==l)return a(n,o,c),a(e,o,t),Promise.resolve();{const s={level:o.level+1,children:new Map};return o.children.set(l,s),Promise.all([B(n,c,s),B(e,t,s)])}}));{const n=e.messageId.substr(2*s.level,2),i=s.children.get(n);return i?B(e,t,i):(a(e,s,t),Promise.resolve())}function a(e,t,s){const a={parent:t,threadNode:s},{id:n,messageId:i}=e;void 0!==n?a.id=n:a.messageId=i;const o=e.messageId.substr(2*t.level,2);t.children.set(o,a)}}function Q(e,t){const s={sentDateById:new Map,children:[],outbound:!1};if(e){const{id:t,sentDate:a}=e;s.sentDateById.set(t,a),s.outbound=e.outbound}return t&&(t.children.push(s),s.parent=t),s}function j(e,t=x){if(!e)return Promise.resolve();if(t.threadNode){if(void 0!==t.messageId)return t.messageId===e?Promise.resolve(t.threadNode):Promise.resolve();if(void 0!==t.id)return k.get(t.id).then((s=>s&&s.messageId===e?t.threadNode:Promise.resolve()));throw new Error("Missing messageId and id: "+JSON.stringify(t))}{const s=e.substr(2*t.level,2),a=t.children.get(s);return a?j(e,a):Promise.resolve()}}var z=s(39045),q=s(78347),W=s(56371),K=s(97823),H=s(16504),G=s(21285),J=s(84321);const Y={call:async function(e,t){const s=Date.now();return await h.Z.transaction("rw",G.E.concat([h.Z.pop,h.Z.filters]),(async()=>{const a=t.filter((e=>!!e.messageId)).map((e=>e.messageId)),n=await h.Z.searchList.where("messageId").anyOf(a).toArray(),{newGroups:i,duplicates:o}=(0,J.R)(e,t,n),r=[];for(const t of o){const{message:a,searchListEntry:n}=t,i={accountId:e,uidl:a.uidl||"",createdTimestamp:s,searchListId:n.id,headersOnly:a.headersOnly};r.push(i)}const c=i.map((e=>e[0])),d=await(0,G.Z)(e,R.Gf,R.e9,c);return d.forEach(((t,a)=>{i[a].forEach((a=>{r.push({accountId:e,uidl:a.uidl,createdTimestamp:s,searchListId:t.id,headersOnly:a.headersOnly})}))})),h.Z.pop.bulkPut(r),o.length>0&&await(0,J.y)(e,R.Gf,R.e9,o,!1),d}))}};var X=s(61472),ee=s(75401),te=s(84283),se=s(89165);function ae(e,t,s,a){return s.some((s=>0!==s.length&&s.every((s=>function(e,t,s,a){if(s.accountId||s.path||s.hasOwnProperty("folder")){const t=g.Z.getByIds(e.sourceFilterIds);let n;if(s.accountId?n=t.some((e=>e.accountId===s.accountId)):s.path&&(n=t.some((e=>e.path===s.path))),s.hasOwnProperty("folder"))if(s.folder===R.uT){const t=!1;n=te.Z.isMessageDeleted(e.sources,a,t)}else n=s.folder===R.Hd?(0,se.Z)(e.sources):s.folder===R.hn?(0,ee.Z)(e.sources):s.folder===R.Z3?!t.some((t=>{if(X.Z.getFolderType(t.accountId,t.path)===R.Nz){return e.sources.get(t.id)?.internal}return!1})):t.some((e=>{const t=X.Z.getFolderType(e.accountId,e.path);return s.folder&&s.folder===t}));if(!n)return!1}if(s.listId&&s.listId!==(0,p.P)(t.listId))return!1;if(s.flag){let t;if((0,O.R7)(s.flag))if(s.flag===R.T4.DELETED)t=te.Z.isMessageDeleted(e.sources,a);else{if(s.flag!==R.T4.SEEN)throw new Error("Unhandled source flag "+s.flag);t=y.Z.call(e.sources,a)}else t=e.flags.includes(s.flag);if(!t)return!1}if(s.senderIsMailingList&&(!e.from[0]||s.senderIsMailingList!==e.from[0].address))return!1;return!0}(e,t,s,a)))))}const ne={searchAddresses:function(e,t){const s=t.map((e=>e.address)),a=e.address;return s.some((e=>e.toLowerCase()===a))},filterMessage:function(e,t,s){let a=!1;const{filterValue:n}=e,{include:i,exclude:o}=n;if(o||i)if(o&&i){const n=ae(t,s,o,e),r=ae(t,s,i,e);!n&&r&&(a=!0)}else i?a=ae(t,s,i,e):o&&(a=!ae(t,s,o,e));else a=!0;return a}},ie={mergeFilteringQueueItems:function(e){const t=new Map,s=new Set;if(e.length<=1)return{updatedItems:t,deletedItemIds:s};let a=e[0];for(let n=1;n<e.length;n++){const i=e[n],o=ie.mergeItems(a,i);o?(a=o,s.add(i.id),t.set(o.id,o)):a=i}return{updatedItems:t,deletedItemIds:s}},mergeItems:function(e,t){if(e.priority!==t.priority)return;if("FILTERS_SLES"===e.type&&"FILTERS_SLES"===t.type)return ie.mergeFiltersSles(e,t)},mergeFiltersSles:function(e,t){if(!ie.filterIdsMatch(e.filterIds,t.filterIds))return;if(!ie.folderIdsMatch(e.folderIds,t.folderIds))return;if(e.runAllMessages!==t.runAllMessages)return;if(e.runMailingLists!==t.runMailingLists)return;if(e.runCustomFolders!==t.runCustomFolders)return;if(e.runFlagFolders!==t.runFlagFolders)return;if(e.runLabels!==t.runLabels)return;if(e.runQueries!==t.runQueries)return;if(e.runSingleThread!==t.runSingleThread)return;const s=new Set([...e.searchListIds,...t.searchListIds]);return{...e,searchListIds:[...s]}},filterIdsMatch:function(e,t){return ie.arraysMatch(e,t,(function(e,t){const s=new Set(t);return!e.some((e=>!s.has(e)))}))},folderIdsMatch:function(e,t){return ie.arraysMatch(e,t,(function(e,t){return!e.some((e=>!t.find((t=>e[0]===t[0]&&e[1]===t[1]))))}))},arraysMatch:function(e,t,s){if(void 0===e&&void 0===t)return!0;if(void 0===e||void 0===t)return!1;if(e.length!==t.length)return!1;return s(e,t)}};const oe=ie;var re=s(5204),ce=s(95538),de=s(81830),le=s(51733);const ue=function(e,t){return[...e.entries()].some((([e,s])=>{if(s.deleted)return!1;const a=g.Z.get(e);if(!a)throw new Error("Source filter not found "+e);const{accountId:n,path:i}=a;return X.Z.getFolderType(n,i)===t}))};var fe=s(34155);const he={filter:ye,filterUpdateSle:async function(e){const{priority:t,searchListIds:s,currentSearchListId:a=0,unread:n,unseen:i,sources:o,removeViewIds:r=new Set,batchSize:c=ge,reRunUpdated:d}=e,l=[],u=Date.now();let f,p;if(s){const e=s.splice(0,c);[f,p]=await h.Z.transaction("rw",[h.Z.searchList,h.Z.viewIds],(()=>Promise.all([h.Z.searchList.where("id").anyOf(e).toArray(),h.Z.viewIds.where("searchListId").anyOf(e).toArray()])))}else{if([f,p]=await h.Z.transaction("rw",[h.Z.searchList,h.Z.viewIds],(()=>Promise.all([h.Z.searchList.where("id").above(a).limit(c).toArray(),h.Z.viewIds.where("searchListId").above(a).limit(c).toArray()]))),0===f.length)return!0;e.currentSearchListId=f[f.length-1].id}const w=new Map(p.map((({searchListId:e,viewIds:t})=>[e,t])));for(const e of f){const t=new Set,s=new Set([...r]),{id:a}=e,c=w.get(a);if(!c)throw new Error("viewIds not found "+a);const d=new Set;if(c.forEach((e=>{const t=Math.floor(e/R.XN);d.add(t)})),d.forEach((a=>{if(void 0!==n){const e=a*R.XN+R.aD;n?t.add(e):s.add(e)}if(void 0!==i){const e=a*R.XN+R.ZC;i?t.add(e):s.add(e)}if(void 0!==o){const n=a*R.XN+R.IK,i=a*R.XN+R.aD;o.forEach(((o,r)=>{a===r?o?(void 0!==o.deleted&&(o.deleted?(0,se.Z)(e.sources)||s.add(n):t.add(n)),void 0!==o.read&&(o.read?s.add(i):t.add(i))):I.Z.getAllViewTypes().forEach((e=>{s.add(a*R.XN+e)})):e.sources.has(a)||(te.Z.isMessageDeleted(e.sources)?s.add(n):t.add(n),y.Z.call(e.sources)?s.add(i):t.add(i))}))}})),c.forEach((e=>{t.delete(e)})),[...s].forEach((e=>{c.includes(e)||s.delete(e)})),t.size>0||s.size>0){const e={id:a,updates:{}};t.size>0&&(e.updates.addedViewIds=[...t],t.forEach((e=>{c.push(e)}))),s.size>0&&(e.updates.removedViewIds=[...s],s.forEach((e=>{const t=c.indexOf(e);t>=0&&c.splice(t,1)}))),l.push(e)}else w.delete(a)}if(w.size>0&&(await h.Z.viewIds.where("searchListId").anyOf([...w.keys()]).modify((e=>{const t=w.get(e.searchListId);t&&(e.viewIds=t)})),d)){const e=[...w.keys()];await m.Z.call({type:"RE_RUN_SLES",priority:t,searchListIds:e})}l.length>0&&v.QO.updateIndex({sleUpdates:l});if(s&&0===s.length)return!0;{const t=Date.now();return e.batchSize=Ie(c,t-u),!1}},filterSles:async function(e,t,s,a,n){const i=[],o=[],r=[],c=[],d=[],l=new Set,u=new Map,f=new Map,w=new Map,y=function(e){const t=new Set,s=[];for(const{accountId:a,path:n}of e)q.Z.isMailAccount(a)&&(n===R.ym?s.push(a):t.add(a));for(const e of s)t.delete(e);if(0===t.size)return[];const a=[...t].map((e=>[e,R.ym]));return g.Z.getByFolderIds(a)}(a),m=[...a,...y];for(let a=0;a<e.length;a++){const i=e[a],o=t[a],r=new Map;for(const e of m){if(ne.filterMessage(e,i,o)){const{query:t}=e.filterValue,a=s.get(i.id);if(!a)throw new Error("viewIds not found in viewIdsBySleId for "+i.id);if(!t||n?.skipQueries||a.includes(e.id*R.XN))r.set(e,!0);else{const t=w.get(e);t?t.push(i):w.set(e,[i])}}else r.set(e,!1)}f.set(i,r)}if(w.size>0)for(const[e,t]of w){const{query:s}=e.filterValue;if(s){const a=await(0,de.Z)(s),n=new Set(a);for(const s of t){let t=f.get(s);t||(t=new Map,f.set(s,t)),n.has(s.id)?t.set(e,!0):t.set(e,!1)}}}for(const e of m){const t=I.Z.getViewIdsByFilterId(e.id);for(const e of t)l.add(e)}for(let a=0;a<e.length;a++){const h=e[a],w=t[a],g=f.get(h);if(!g)continue;const I=he.getMatchResults(h,w,g,n?.triggerFilterIdCandidates),{id:y}=h,{addedViewIds:m,removedViewIds:L,runTriggerFilterIds:v,isOnMailingList:E}=I,Z=s.get(y);if(!Z)throw new Error("viewIds not found in viewIdsBySleId for "+y);if(E){[...Z,...m].filter((e=>(e-R.EO)%R.XN==0)).forEach((e=>{m.delete(e),L.add(e)}))}const b=Z.filter((e=>l.has(e))),A=b.filter((e=>!L.has(e))).concat([...m]);let S;if(!(A.length===b.length&&A.every((e=>b.includes(e))))){const e=Z.filter((e=>!L.has(e))).concat([...m]);u.set(y,e),S={addedViewIds:[...m].filter((e=>!Z.includes(e))),removedViewIds:Z.filter((e=>L.has(e)&&!m.has(e)))},s.set(y,e)}v.size>0&&(S={...S||{},runTriggerFilterIds:[...v]}),S&&i.push({id:y,updates:S}),(0,p.P)(w.listId)&&(o.push(h),r.push(w)),(0,O.OK)(h.flags)&&(c.push(h),d.push(w))}u.size>0&&await h.Z.viewIds.where("searchListId").anyOf([...u.keys()]).modify((e=>{const t=u.get(e.searchListId);t&&(e.viewIds=t)}));return{sleUpdates:i,mailingListCandidateSles:o,mailingListCandidateMessages:r,labelsCandidateSles:c,labelsCandidateMessages:d}},getMatchResults:function(e,t,s,a){const n=new Set,i=new Set,o=new Set,r=g.Z.getByIds(e.sourceFilterIds);let c=!1;for(const[d,l]of s){const s=I.Z.getViewIdsByFilterId(d.id);for(const e of s)i.add(e);l&&(a?.includes(d.id)&&o.add(d.id),s.forEach((s=>{switch(I.Z.getViewType(s)){case R.xE:n.add(s);break;case R.ZC:e.unseen&&n.add(s);break;case R.aD:y.Z.call(e.sources,d)||n.add(s);break;case R.EO:const a=(0,p.P)(t.listId);if(a){const e=ce.Z.getMailingListGroup(a);e&&e.isIgnored?n.add(s):c=!0}else Le(e.from)?c=!0:n.add(s);break;case R.IK:const i=X.Z.getFolderType(d.accountId,d.path)===R.Nz;te.Z.isMessageDeleted(e.sources,d,i)||n.add(s);break;case R.Fz:r.some((e=>e.accountId!==R.u4))&&n.add(s);break;case R.Jq:(0,se.Z)(e.sources)||n.add(s);break;case R.js:const o=ue(e.sources,R.Oi),l=ue(e.sources,R.e9);o&&!l||n.add(s);break;case R.pF:(0,ee.Z)(e.sources)||n.add(s)}})))}return{addedViewIds:n,removedViewIds:i,runTriggerFilterIds:o,isOnMailingList:c}},updateFilteringQueue:async function(){return h.Z.transaction("rw",[h.Z.filteringQueue],(async()=>{const e=me.reduce(((e,{id:t})=>Math.max(e,t)),0),t=await h.Z.filteringQueue.where("id").above(e).toArray();me.push(...t),me.sort(le.Hc);const{updatedItems:s,deletedItemIds:a}=oe.mergeFilteringQueueItems(me);if(0===s.size&&0===a.size)return me;const n=[];for(const e of me){const t=s.get(e.id);t?n.push(t):a.has(e.id)||n.push(e)}return me=n,h.Z.filteringQueue.bulkPut([...s.values()]),h.Z.filteringQueue.bulkDelete([...a]),n}))},clearQueue:function(){me=[]},deleteFilteringItem:async function(e){await h.Z.filteringQueue.delete(e.id);const t=me.indexOf(e);t>=0&&me.splice(t,1)}};let pe=!1;const we=100,ge=2e3,Ie=C.Z.adjustBatchSize.bind(void 0,we,2e4,1e3);async function ye(){return pe?Promise.resolve():(pe=!0,new Promise((e=>{!async function t(){const s=(await he.updateFilteringQueue())[0];if(void 0===s)return pe=!1,v.U.clearPersistentStatus(T.A4,"MAIL_FILTERING"),void e();v.U.setPersistentStatus(T.A4,"MAIL_FILTERING","Running mail filters...");let a=!0;try{switch(s.type){case"FILTERS_SLES":a=await async function(e){const{filterIds:t,folderIds:s=[],searchListIds:a,runAllMessages:n=!1,runMailingLists:i=!1,runCustomFolders:o=!1,runLabels:r=!1,runFlagFolders:c=!1,runQueries:d=!1,runSingleThread:l=!1,batchSize:u=ge}=e,f=g.Z.getAll().filter((e=>{const{id:a,accountId:u,path:f}=e;if(!!s.find((e=>{const[t,s]=e;return t===u&&s===f})))return!0;if(t&&t.includes(a))return!0;switch(u){case R.of:return n&&[R.ym,R.tB,R.ik,R.rp,R.N1,R.cm,R.$T].includes(f);case R.wC:return i;case R.MN:return c;case R.Ry:return o;case R.ut:return r;case R.Kz:return d;case R.tQ:return l}}));if(0===f.length)return!0;const w=Date.now(),I=a.splice(0,u),[y,m,L]=await h.Z.transaction("rw",[h.Z.searchList,h.Z.messages,h.Z.viewIds],(()=>Promise.all([h.Z.searchList.where("id").anyOf(I).toArray(),h.Z.messages.where("id").anyOf(I).toArray(),h.Z.viewIds.where("searchListId").anyOf(I).toArray()])));if(0===y.length)return!0;const E=new Map(L.map((e=>[e.searchListId,e.viewIds]))),Z=await he.filterSles(y,m,E,f),{sleUpdates:b,mailingListCandidateSles:A,mailingListCandidateMessages:S,labelsCandidateSles:M,labelsCandidateMessages:F}=Z;b.length>0&&v.QO.updateIndex({sleUpdates:b});if(A.length>0){const e=await p.Z.createMailingListFilters(S);if(e.length>0){await g.Z.updateFilters(e.map((({id:e})=>e)));const t=await he.filterSles(A,S,E,e),{sleUpdates:s}=t;s.length>0&&v.QO.updateIndex({sleUpdates:s})}}if(M.length>0){const e=await(0,O.uR)(M);await g.Z.updateFilters(e);const t=g.Z.getByIds(e),s=await he.filterSles(M,F,E,t),{sleUpdates:a}=s;a.length>0&&v.QO.updateIndex({sleUpdates:a})}if(a.length>0){const t=Date.now();e.batchSize=Ie(u,t-w)}return 0===a.length}(s);break;case"UPDATE_SLE":a=await he.filterUpdateSle(s);break;case"MOVE_SLE":await async function(e){const{searchListIds:t,fromFolderId:s,toFolderId:a}=e,n=g.Z.getByFolderId(s),i=g.Z.getByFolderId(a);if(!n||!i)throw new Error("Either from- or to-filter not found");const o=[],[r,c]=await h.Z.transaction("rw",[h.Z.searchList,h.Z.viewIds],(()=>Promise.all([h.Z.searchList.where("id").anyOf(t).toArray(),h.Z.viewIds.where("searchListId").anyOf(t).toArray()]))),d=new Map(c.map((e=>[e.searchListId,e.viewIds]))),l=new Set,u=new Set;for(const e of r){const{id:t}=e,s=d.get(t);if(!s)throw new Error("viewIds not found "+t);const a={id:t,updates:{}};for(const e of I.Z.getAllViewTypes()){const t=n.id*R.XN+e;if(s.includes(t)){const s=i.id*R.XN+e;u.add(t),l.add(s)}}a.updates.addedViewIds=[...l],a.updates.removedViewIds=[...u],o.push(a),u.forEach((e=>{const t=s.indexOf(e);t>=0&&s.splice(t,1)})),l.forEach((e=>{s.push(e)}))}await h.Z.viewIds.where("searchListId").anyOf([...d.keys()]).modify((e=>{const t=d.get(e.searchListId);t&&(e.viewIds=t)})),v.QO.updateIndex({sleUpdates:o})}(s);break;case"RUN_FILTERS":a=await async function(e){const t=[],{filterIds:s,folderIds:a,currentSearchListId:n=0,batchSize:i=ge,triggerFilterIdCandidates:o}=e;if(s){const e=g.Z.getByIds(s);t.push(...e)}if(a){const e=g.Z.getByFolderIds(a);t.push(...e)}if(0===t.length)throw new Error("No valid filters in filtering request");const r=Date.now(),[c,d,l]=await h.Z.transaction("rw",[h.Z.searchList,h.Z.messages,h.Z.viewIds],(()=>Promise.all([h.Z.searchList.where("id").above(n).limit(i).toArray(),h.Z.viewIds.where("searchListId").above(n).limit(i).toArray(),h.Z.messages.where("id").above(n).limit(i).toArray()])));if(0===c.length)return!0;const u=new Map(d.map((e=>[e.searchListId,e.viewIds])));e.currentSearchListId=c[c.length-1].id;const f=await he.filterSles(c,l,u,t,{triggerFilterIdCandidates:o}),{sleUpdates:p}=f;p.length>0&&v.QO.updateIndex({sleUpdates:p});const w=Date.now();return e.batchSize=Ie(i,w-r),!1}(s);break;case"RE_RUN_SLES":a=await async function(e){const{filterIds:t,folderIds:s,batchSize:a=we,currentSearchListId:n=0,runMailingLists:i=!1}=e,o=[];t&&o.push(...t);if(s){const e=g.Z.getByFolderIds(s);o.push(...e.map((e=>e.id)))}const r=Date.now(),c=[],d=[],[l,u,f]=e.searchListIds?await async function(e,t){const s=e.splice(0,t);return await h.Z.transaction("rw",[h.Z.searchList,h.Z.messages,h.Z.viewIds],(()=>Promise.all([h.Z.searchList.where("id").anyOf(s).toArray(),h.Z.messages.where("id").anyOf(s).toArray(),h.Z.viewIds.where("searchListId").anyOf(s).toArray()])))}(e.searchListIds,a):await async function(e,t){return h.Z.transaction("rw",[h.Z.searchList,h.Z.messages,h.Z.viewIds],(()=>Promise.all([h.Z.searchList.where("id").above(e).limit(t).toArray(),h.Z.messages.where("id").above(e).limit(t).toArray(),h.Z.viewIds.where("searchListId").above(e).limit(t).toArray()])))}(n,a);if(0===l.length)return!0;void 0===e.searchListIds&&(e.currentSearchListId=l[l.length-1].id);const w=g.Z.getAll(),I=new Map(f.map((e=>[e.searchListId,e.viewIds]))),y=[];for(let e=0;e<l.length;e++){const t=l[e],s=I.get(t.id),a=y.find((e=>{const[t]=e;if(s.length!==t.length)return!1;for(let e=0;e<t.length;e++)if(s[e]!==t[e])return!1;return!0})),n=u[e];if(a){const[,[e,s]]=a;e.push(t),s.push(n)}else y.push([s,[[t],[n]]])}const m=[];for(const t of y){const[s,[a,n]]=t,r=new Set([...o,...m]);s.forEach((e=>{const t=Math.floor(e/R.XN);r.add(t)}));const l=w.filter((e=>r.has(e.id)));if(0===l.length)continue;const{skipQueries:u}=e,f=await he.filterSles(a,n,I,l,{skipQueries:u}),{mailingListCandidateSles:h,mailingListCandidateMessages:y}=f;if(c.push(...f.sleUpdates),i&&h.length>0){const t=await p.Z.createMailingListFilters(y);if(t.length>0){const s=t.map((({id:e})=>e));await g.Z.updateFilters(s);const{filterIds:a=[]}=e;e.filterIds=[...a,...s],m.push(...s);const n=await he.filterSles(h,y,I,t,{skipQueries:u}),{sleUpdates:i}=n;d.push(...i)}}}c.length>0&&v.QO.updateIndex({sleUpdates:c});d.length>0&&v.QO.updateIndex({sleUpdates:d});const L=Date.now();return e.batchSize=Ie(a,L-r),!1}(s);break;default:console.warn("Invalid filtering queue item type",s.type)}a&&await he.deleteFilteringItem(s)}catch(e){console.error("Filtering failed",JSON.stringify(s),e),await he.deleteFilteringItem(s)}fe.nextTick(t)}()})))}let me=[];function Le(e){const t=e[0]?.address;return!!t&&!!g.Z.getByAddress(t)}re.Z.addListener((async function(e){if("filter"===e.func)await ye()}));const ve=he;function Ee(e,t){return h.Z.pop.where("[accountId+uidl]").equals([e,t]).toArray()}var Ze=s(77150),be=s.n(Ze),Ae=s(16445),Oe=s(11430),Se=s(76257),Me=s(13519);async function Fe(e,t){const s=(0,Se.PW)((0,Se.Zp)(t));if(s){const a=await Oe.Z.parse(t,s.mimeTree),n=(0,Me.H)(a.bodyParts);if(!await l.Z.mailPrivate.addMessageBody(e,n))throw new Error(`Failed to add body to FTS db for id ${e}`);return a.raw}return t}var Re=s(79513);var Te=s(13617),Ue=s(34155);let _e=!1;function Pe(e){return $(e).then((e=>{if(!e.parent&&0===e.children.length)return[];let s=e;for(;s.parent;)s=s.parent;return t(s)}));function t(e,n){const{sentDateById:i,children:o}=e;let r,c=[];if(void 0===n){let t=s(e);t||(t=s(e,!1));let n=e.sentDateById.keys().next().value;n||(n=a(e,[0,Number.MAX_SAFE_INTEGER])[0]),r=(0,Te._)(t,n),i.forEach(((e,t)=>{c.push({id:t,newThreadKey:r})}))}else i.forEach(((e,t)=>{r=[...n,e],c.push({id:t,newThreadKey:r})}));return o.forEach((e=>{const s=t(e,r);c=[...c,...s]})),c}function s(e,t=!0){const a=t&&e.outbound;let n=[...e.sentDateById.values()].reduce(((e,t)=>Math.max(e,a?0:t)),0);return e.children.forEach((e=>{n=Math.max(n,s(e,t))})),n}function a(e,t){return t=[...e.sentDateById.entries()].reduce(((e,t)=>e[1]<t[1]?e:t),t),e.children.forEach((e=>{t=a(e,t)})),t}}function Ne(){return _e?Promise.resolve():(_e=!0,new Promise(((e,t)=>{!function s(){h.Z.transaction("rw",[h.Z.threading,h.Z.threadingQueue,h.Z.searchList,h.Z.messages],(()=>{h.Z.threadingQueue.toCollection().first().then((t=>{if(!t)return D(),_e=!1,void e();const{threadingIds:s}=t;h.Z.threading.where("id").anyOf(s).toArray().then((e=>{const t=new Map;V(e),e.reduce(((e,s)=>e.then((()=>e.then((()=>Pe(s))).then((e=>{e.forEach((e=>{const{id:s,newThreadKey:a}=e;t.set(s,a)}))}))))),Promise.resolve()).then((async()=>{if(t.size>0){const e=await function(e){const t=new Map,s=[...e.keys()];return h.Z.searchList.where("id").anyOf(s).modify((s=>{const{id:a}=s,n=e.get(a);n&&(t.set(a,n),s.threadKey=n)})).then((()=>t))}(t);v.QO.updateThreadKeys(e)}}))})).then((()=>h.Z.threadingQueue.delete(t.id)))}))})).catch((e=>{_e=!1,console.error(e),v.U.setStatus(T.A4,(0,W.Z)("Error during threading"),5e3),t()})).then((()=>{_e&&Ue.nextTick(s)}))}()})))}const Ce={updateThreads:Ne,rerunThreading:function(e,t){return v.U.setStatus(T.A4,(0,W.Z)("Re-threading - $1 $2",[e,t]),5e3),function(e,t){return h.Z.imap.where("[accountId+path+uid]").between([e,t,0],[e,t,1/0]).toArray().then((e=>{const t=e.map((e=>e.searchListId));return(0,L.Z)(t)}))}(e,t).then((()=>Ne()))}};var xe=s(70520),ke=s(99895);const De=6e4,Ve=1048576;class $e extends Error{constructor(e,t,s,a){super(e),this.details=t,this.socket=s,this.original=a}}function Be(e){return e.match(/^\+OK/)}function Qe(e){return 0===e.indexOf("PASS")?"PASS":0===e.indexOf("APOP")?e.replace(/\w+\s*$/,"the_md5_hash"):e}async function je(e,t,s=!1){if(!e)throw new $e("NO_SOCKET",(0,W.Z)('No POP socket when sending "$1"',[Qe(t)]),e);if(await!qe(e))throw new $e("SOCKET_CLOSED",(0,W.Z)('POP socket unexpectedly closed before "$1" command could be sent',[Qe(t)]),e);let a="";return new Promise(((n,i)=>{let o=setTimeout((function(){clearTimeout(o),i(new $e("SOCKET_TIMEOUT",(0,W.Z)('POP server did not reply to command "$1" after $2 ms',[Qe(t),De]),e))}),3e4);e.onerror=s=>{clearTimeout(o),i(new $e("SEND_ERROR",(0,W.Z)('POP socket generated unknown error when sending command "$1"',[Qe(t)]),e,s))};let r=Date.now();e.ondata=c=>{clearTimeout(o);const d=new Uint8Array(c.data),l=(0,xe.Z)(d);if(a+=l,Date.now()-r>1e3){const e=Math.round(a.length/Ve*10)/10;v.U.setStatus(T.A4,(0,W.Z)("Fetching message: $1 MB",[e])),r=Date.now()}s&&a.startsWith("+OK")&&a.endsWith("\r\n.\r\n")||(!s||s&&a.startsWith("-ERR"))&&a.endsWith("\r\n")?n(a):o=setTimeout((function(){i(new $e("SOCKET_TIMEOUT",(0,W.Z)('POP server failed to send additional chunk for command "$1" after $2 ms',[Qe(t),De]),e))}),De)};const c=`${t}\r\n`,d=(0,Re.Z)(c);e.send(d)}))}function ze(e,t,s){return je(e,`USER ${t}`).then((t=>{if(Be(t)){const t=(0,xe.Z)((new TextEncoder).encode(s));return je(e,`PASS ${t}`)}throw new $e("AUTH_FAIL",(0,W.Z)("Invalid username for POP, server responded with: $1",[t]),e)})).then((t=>{if(!Be(t))throw new $e("AUTH_FAIL",(0,W.Z)("Login to POP server failed, server responded with: $1",[t]),e)}))}function qe(e){return new Promise(((t,s)=>{setTimeout((()=>{t("open"===e.readyState)}),0)}))}function We(e,t,s,a,n=6e4,i=!1){return function(e,t,s){let a="";return new Promise(((n,i)=>{let o=setTimeout((function(){i(new $e("SOCKET_TIMEOUT",(0,W.Z)("Failed to connect to POP server after $1 ms",[s]),r))}),s);const r=H.default.open(e,t,{useSecureTransport:110!==t});if("connecting"!==r.readyState)return clearTimeout(o),void i(new $e("NO_SOCKET",(0,W.Z)('POP socket did not switch to "connecting" when trying to connect to $1:$2',[e,t]),r));r.onerror=e=>{clearTimeout(o),i(new $e("NO_SOCKET",(0,W.Z)("POP socket generated unknown error when connecting. Response message: $1",[e.data.message]),r,e))},r.ondata=e=>{clearTimeout(o);const t=new Uint8Array(e.data),s=(0,xe.Z)(t);a+=s,a.endsWith("\r\n")?n({socket:r,message:s}):o=setTimeout((function(){i(new $e("SOCKET_TIMEOUT",(0,W.Z)("POP server failed to send connection chunk after $1 ms",[De]),r))}),De)}}))}(e,t,n).then((o=>{const{socket:r,message:c}=o;if(Be(c)){const o=c.match(/(<[^>]+>)\s*$/);return o&&!i?function(e,t,s,a){const n=(0,xe.Z)((new TextEncoder).encode(s)),i=be()(`${a}${n}`);return je(e,`APOP ${t} ${i}`).then((t=>{if(!Be(t))throw new $e("AUTH_FAIL",(0,W.Z)("APOP authentication failed: $1",[t]),e)}))}(r,s,a,o[1]).then((()=>r)).catch((i=>"AUTH_FAIL"===i.message?qe(r).then((i=>i?ze(r,s,a).then((()=>r)):We(e,t,s,a,n,!0))):Promise.reject(i))):ze(r,s,a).then((()=>r))}throw new $e("CONNECT_ERROR",(0,W.Z)("POP server $1:$2 responded with an error after connection",[e,t]),r)}))}function Ke(e){const t=e.indexOf("\r\n");if(-1===t)throw new Error("parseRetrResponse: Expected end of line");if(!e.endsWith(".\r\n"))throw new Error("parseRetrResponse: expected termination character");let s=e.substr(t+2,e.length-t-5);return"."===s[0]&&(s=s.substr(1)),s=s.replaceAll("\r\n.","\r\n"),(0,Re.Z)(s)}async function He(e,t,s){if(s&&t.headersOnly){const a=await je(e,`TOP ${t.index} 0`,!0);if(Be(a)){return{message:{...t,message:Ke(a)},topworked:s}}s=!1,t.headersOnly=!1,console.debug(new $e("TOP_ERROR",(0,W.Z)("POP server did not respond correctly to TOP command. Response: $1",[a])))}else t.headersOnly&&(t.headersOnly=!1);const a=await je(e,`RETR ${t.index}`,!0);if(Be(a)){return{message:{...t,message:Ke(a)},topworked:s}}throw new $e("RETR_ERROR",(0,W.Z)("POP server did not respond correctly to RETR command. Response: $1",[a]),e)}function Ge(e){return e.split(/[\r\n]+/g).slice(1).filter((e=>e&&"."!==e&&e.match(/^\d+\s+\S+$/))).map((e=>{const t=e.split(/\s+/);return{index:Number(t[0]),uidl:t[1],headersOnly:!1}}))}async function Je(e,t,s){if(!s.message)throw new $e("RETR_ERROR",(0,W.Z)("Unable to store POP message as it does not seem to be result of a RETR command. $1 $2",[t,s.uidl]),e);const a=(0,Ae.Z)(s.message),n={to:a.to,from:a.from,cc:a.cc,inReplyTo:a.inReplyTo,replyTo:a.replyTo,subject:a.subject,sentDate:a.sentDate,messageId:a.messageId,listId:a.listId,references:a.references,flags:[],uidl:s.uidl||"",headersOnly:s.headersOnly};n.messageId||(n.messageId="");const i=await Y.call(t,[n]).catch((s=>{throw new $e("STORE_ERROR",(0,W.Z)("Unable to store POP message in mail store.",[t]),e,s)}));return i.length>0&&(s.message=await Fe(i[0].id,s.message)),i}async function Ye(e,t,s,a,n){try{await ke.Z.call(t,a,n,s.message)}catch(s){throw new $e("STORE_ERROR",(0,W.Z)("Unable to store POP message as writing to disk failed.",[t]),e,s)}}function Xe(e){switch(e.message){case"SOCKET_TIMEOUT":case"SEND_ERROR":case"CONNECT_ERROR":case"DELETE_ERROR":case"NO_UIDL":case"NO_SOCKET":e.socket&&e.socket.close();break;case"MISCONFIGURED_ACCOUNT":case"SOCKET_CLOSED":break;default:if(e.socket){const t=e.socket;return je(e.socket,"QUIT").then((s=>(t.close(),Promise.reject(e))))}}return e.socket&&(e.socket.onerror=null),Promise.reject(e)}async function et(e,t,s,a){const n=e.MAIL_USER,i=e.MAIL_PASSWORD,o=e.MAIL_SERVER,r=e.MAIL_PORT,c=e.popMaxSize||{limited:!1,limit:0},d=c.limited?c.limit*Ve:0,l=e.MAIL_EMAIL,u=e.popDeletion||{when:R.qd,howManyDays:0},f=u.when;if(!(n&&i&&o&&r))throw new $e("MISCONFIGURED_ACCOUNT",(0,W.Z)("Incoming POP server attributes missing for $1",[l]));try{s?v.U.setStatus(T.A4,(0,W.Z)("Fetching mail on POP account $1",[l])):v.U.setStatus(T.A4,(0,W.Z)("Checking for new mail on POP account $1",[l]));const e=await We(o,r,n,i),c=await async function(e,t,s){const a=await je(e,"UIDL",!0);if(Be(a)){const n=Ge(a);if(v.U.setStatus(T.A4,(0,W.Z)("$1 message exists on POP account $2","$1 messages exist on POP account $2",[n.length,s])),t){const t=await je(e,"LIST",!0);if(!Be(t))throw new $e("NO_LIST",(0,W.Z)("POP server $1 does not support LIST",[s]),e);Ge(t).forEach((e=>{const t=n.findIndex((t=>t.index===e.index));-1!==t&&(n[t].size=parseInt(e.uidl))}))}return n}throw new $e("NO_UIDL",(0,W.Z)("POP server $1 does not support UIDL",[s]),e)}(e,d,l);let h=[],p=[],w=[];const g=[];if(s){let e=0;for(const t of c)s[e]===t.uidl&&(h.push(t),e++);if(t){w=h.slice(t),h=h.slice(0,t);let e=Date.now();h.forEach(((t,s)=>{Date.now()-e>1e3&&(v.U.setStatus(T.A4,(0,W.Z)("Checking if complete or partial mail should be loaded - $1 $2/$3",[l,s+1,h.length])),e=Date.now()),d&&t.size&&t.size>d?t.headersOnly=!0:p.push(t)}))}else h.forEach((e=>e.headersOnly=!1)),p=[...h]}else{let s=Date.now(),a=0;for(const n of c){const{index:i,uidl:o}=n;if(!o)throw new $e("LIST_ERROR",(0,W.Z)("POP message does not have UIDL: $1 index: $2",[l,i]),e);Date.now()-s>1e3&&(v.U.setStatus(T.A4,(0,W.Z)("Comparing server messages to stored messages - $1 $2/$3",[l,i,c.length])),s=Date.now());const r=await Ee(l,o);0===r.length?(a++,!t||a<=t?(d&&n.size&&n.size>d?n.headersOnly=!0:p.push(n),h.push(n)):w.push(n)):r[0].headersOnly||(p.push(n),f===R.kA&&r[0].createdTimestamp+24*u.howManyDays*60*60*1e3<Date.now()&&g.push(n))}v.U.setStatus(T.A4,(0,W.Z)("Need to fetch $1 messages - $2",[h.length+w.length,l]))}const I=[];let y,m=!0,L=0,E=Date.now();for(const s of h){L++;const{message:n,topworked:i}=await He(e,s,m);if(m=i,a)y=n.message,v.QO.runStoredQueryFilters([a.id]);else{const t=await Je(e,l,n);if(t.length>0&&(I.push(...t),!s.headersOnly)){const{sentDate:s,id:a}=t[0];await Ye(e,l,n,s,a)}}if(s.headersOnly&&!n.headersOnly&&p.push(s),Date.now()-E>1e3){const e=h.length+w.length;v.U.setStatus(T.A4,(0,W.Z)("Fetching in batches of $1 messages - $2 $3/$4",[t,l,L,e])),E=Date.now()}ve.filter(),v.QO.updateIndex({addedSles:I}),Ce.updateThreads()}if(f===R.eQ||f===R.kA){const t=f===R.eQ?p:g;await tt(e,t)}await je(e,"QUIT"),e.close();return{fetchedNum:h.length,addedSles:I,pendingUidls:w.map((e=>e.uidl)),fullMessage:y}}catch(e){return await Xe(e)}}async function tt(e,t){for(const s of t){if(!Be(await je(e,`DELE ${s.index}`)))throw new $e("DELETE_ERROR",(0,W.Z)("Failed to delete mail with index $1",[s.index]),e)}}const st={verifyLogin:async function(e){const{MAIL_SERVER:t,MAIL_PORT:s,MAIL_USER:a,MAIL_PASSWORD:n}=e;if(!(t&&s&&a&&n))throw new $e("MISCONFIGURED_ACCOUNT",(0,W.Z)("Incoming server attributes missing for $1",[e.MAIL_EMAIL]));try{const e=await We(t,s,a,n,1e4);await je(e,"QUIT"),await e.close()}catch(e){return await Xe(e)}},deleteMail:async function(e,t){if(e.popDeletion&&e.popDeletion.when===R.Qp){const s=e.MAIL_EMAIL,a=(await h.Z.pop.where("searchListId").anyOf(t).toArray()).filter((e=>e.accountId===s)).map((e=>e.uidl)),n=e.MAIL_USER,i=e.MAIL_PASSWORD,o=e.MAIL_SERVER,r=e.MAIL_PORT;if(!(n&&i&&o&&r))throw new $e("MISCONFIGURED_ACCOUNT",(0,W.Z)("Can not delete POP mail, incoming POP server attributes missing for $1",[e.MAIL_EMAIL]));let c;try{c=await We(o,r,n,i);const e=await je(c,"UIDL",!0);let t;if(!Be(e))throw new $e("NO_UIDL",(0,W.Z)("POP server $1 does not support UIDL",[s]),c);t=Ge(e).filter((e=>e.uidl&&-1!==a.indexOf(e.uidl)));await tt(c,t),await je(c,"QUIT"),await c.close()}catch(e){Xe(e)}}},getFirstBatch:async function(e,t){return await et(e,t)},getMessage:async function(e,t,s){const a=await et(e,0,[t],s);if(!a.fullMessage)throw new Error("Failed to get full message");return a.fullMessage},getNextBatch:async function(e,t,s){return await et(e,t,s)}};let at=!1;const nt={};async function it(e){if(e.isDeleted)return;const t=e.MAIL_EMAIL;if(!navigator.onLine)return void v.U.setStatus(T.A4,(0,W.Z)("No network connection"));if(e.offline)return void v.U.setStatus(T.A4,(0,W.Z)("Account $1 has been set as an offline account. Check settings.",[t]));if(!e.MAIL_PORT||e.MAIL_PORT<=0)throw new Error(`Port missing or invalid: ${e.MAIL_PORT||""}`);if(nt[t])return;nt[t]=!0,v.U.setStatus(T.A4,(0,W.Z)("Indexing - $1 $2",[t,R.Gf]));const s=C.Z.adjustBatchSize.bind(void 0,100,1e4,6e4);let a,n=200;try{await async function t(){const i=Date.now();let o=0;try{let r;if(r=a?await st.getNextBatch(e,n,a):await st.getFirstBatch(e,n),a=r.pendingUidls,o=r.fetchedNum,0===o)return}catch(t){!function(e,t){if(t instanceof $e){console.error(t,t.details),t.original&&console.error(t.original);const s=`${e.MAIL_SERVER||""} / ${e.MAIL_USER||""}: ${t.name} `;t.details=s+t.details,v.U.setStatus(T.A4,t.details)}else console.error(t)}(e,t)}finally{if(o>0){const e=Date.now();n=s(n,e-i),n=Math.min(n,a.length),await t()}}}()}finally{nt[t]=!1}v.U.setStatus(T.A4,(0,W.Z)("Finished indexing - $1",[t]),R.QM),v.QO.removePathIndicator(t,R.Gf,"INDICATOR_TYPE_FETCHING")}async function ot(e){let t=await K.Z.loadPopAccounts();if(t=t.filter((e=>!e.offline)),t)if(e){const s=t.find((t=>t.MAIL_EMAIL===e));s&&await it(s)}else for(let e=0;e<t.length;e++)await it(t[e])}function rt(e,t){return st.deleteMail(e,t)}function ct(e,t,s){return st.getMessage(e,t,s)}const dt={checkForMail:ot,deletePopMail:rt,getPopMessage:ct,setCheckInterval:function(e,t){at&&clearInterval(at),at=!!e&&setInterval(ot,6e4*t)},verifyPopLogin:function(e){return st.verifyLogin(e)}};self.addEventListener("message",(async function({origin:e,data:t,source:s}){if(e!==T.oP||!t||!t.pop)return;const{promiseId:a,func:n,args:i=[]}=t.pop;if(n)try{const e=await dt[n](...i),t=e&&"getPopMessage"===n?[e.buffer]:void 0;s.postMessage({pop:{promiseId:a,results:e}},{transfer:t})}catch(e){s.postMessage({pop:{promiseId:a,error:e.details||e}})}}),!1);const lt=ot;var ut=s(90864);var ft=s(47513),ht=s.n(ft),pt=s(10048),wt=s(93818);const gt={byIds:async function(e){await h.Z.buffer.bulkDelete(e)},byUids:async function(e,t,s){await h.Z.buffer.where("[accountId+path]").equals([e,t]).filter((e=>void 0!==e.uids)).modify((function(e){const t=new Set(e.uids);s.forEach((e=>{t.delete(e)})),0===t.size?delete this.value:e.uids=[...t]}))}};var It=s(55346),yt=s(68247),mt=s(87155);function Lt(e){const t=a.Z.get(F.kMailAccounts).slice(),s=t.findIndex((t=>t.MAIL_EMAIL===e));if(-1===s)throw new Error(`Account to be removed, ${e}, was not found in settings`);const n=t.splice(s,1);yt.Z.set(F.kMailAccounts,t);const i=n[0];l.Z.savedpasswords.delete(!0,(0,mt.B)(i)),l.Z.savedpasswords.delete(!0,(0,mt.Y)(i))}var vt=s(90808),Et=s(26591);async function Zt(e,t,s){v.U.setStatus(T.A4,(0,W.Z)("Removing data from $1 in $2",[t,e]));const a=[e,t,0],n=[e,t,Number.MAX_VALUE];await h.Z.imap.where("[accountId+path+uid]").between(a,n).delete(),await h.Z.mailboxCache.where("[accountId+path]").equals([e,t]).delete();const i=await h.Z.filters.where("[accountId+path]").equals([e,t]).first(),o=await h.Z.filters.toCollection().filter((s=>s.accountId===e&&s.path===t||(s.accountId===R.Ry&&s.path===e+"/"+t||s.selectedAccountId===e&&s.selectedName===i.name))).primaryKeys(),r=await Ot(e,o);e===R.u4&&await h.Z.deletedFeedItems.where("path").equals(t).delete(),s&&await At(e,r),await h.Z.buffer.where("[accountId+path]").equals([e,t]).delete(),v.U.setStatus(T.A4,(0,W.Z)("Finshed removing data from $1 in $2",[t,e]))}async function bt(e,t){v.U.setStatus(T.A4,(0,W.Z)("Removing data for $1",[e]));const s=[e,""],a=[e,"￿"];await h.Z.imap.where("accountId").equals(e).delete(),await h.Z.pop.where("accountId").equals(e).delete(),await h.Z.mailboxCache.where("accountId").equals(e).delete();const n=await h.Z.filters.where("[accountId+path]").between(s,a).toArray(),i=n.map((e=>e.id)),o=n.map((t=>[R.Ry,e+"/"+t.path])),r=await h.Z.filters.where("[accountId+path]").anyOf(o).primaryKeys(),c=await Ot(e,i.concat(r));t&&await At(e,c),await h.Z.buffer.where("accountId").equals(e).delete(),v.U.setStatus(T.A4,(0,W.Z)("Finished removing data for $1",[e]))}async function At(e,t){v.U.setStatus(T.A4,(0,W.Z)("Removing raw message files for $1",[e])),await Promise.all(t.map((t=>{Et.Z.call(e,t.id,t.sentDate).catch((s=>console.warn(`Error deleting file for ${e}/${t.id}. May not exist! ${s}`)))})))}async function Ot(e,t){const s=[],a=[],n=new Set;let i;t.forEach((e=>{for(let t=0;t<R.XN;t++)n.add(e*R.XN+t)})),await h.Z.transaction("rw",[h.Z.messages,h.Z.searchList,h.Z.threading,h.Z.filters,h.Z.viewIds,h.Z.systemTasks],(async()=>{v.U.setStatus(T.A4,(0,W.Z)("Updating database...")),await h.Z.searchList.where("sourceFilterIds").anyOf(t).distinct().modify(((e,n)=>{if(t.forEach((t=>{e.sources.delete(t)})),e.sources.size>0){const a=new Set(t);e.sourceFilterIds=e.sourceFilterIds.filter((e=>!a.has(e))),s.push(e)}else a.push(e),delete n.value})),i=a.map((e=>e.id)),v.U.setStatus(T.A4,(0,W.Z)("Removing messages...")),await Promise.all([h.Z.messages.where("id").anyOf(i).delete().then((()=>v.U.setStatus(T.A4,(0,W.Z)("Removing threading info...")))),h.Z.threading.where("id").anyOf(i).delete().then((()=>v.U.setStatus(T.A4,(0,W.Z)("Removing header info...")))),h.Z.viewIds.where("searchListId").anyOf(i).delete().then((()=>v.U.setStatus(T.A4,(0,W.Z)("Updating view indices...")))),h.Z.viewIds.where("searchListId").anyOf(s.map((e=>e.id))).modify((e=>{e.viewIds=e.viewIds.filter((e=>!n.has(e)))})).then((()=>v.U.setStatus(T.A4,(0,W.Z)("Removing message filters...")))),h.Z.filters.where("id").anyOf(t).delete().then((()=>v.U.setStatus(T.A4,(0,W.Z)("Finished updating database"))))]);const e={taskName:"delete_full_text_search_entries",currentPosition:0,searchListIds:i},o={id:await h.Z.systemTasks.add(e),...e};v.QO.runSystemTask(T.A4,o)})),g.Z.updateFilters(t);const o=s.map((e=>{const s=new Map([...t.map((e=>[e,void 0]))]);for(const[t,a]of e.sources)s.set(t,{...a});return{id:e.id,updates:{sources:s,sourceFilterIds:e.sourceFilterIds,removedViewIds:[...n]}}})),r={removedSles:i,sleUpdates:o};return v.QO.updateIndex(r),a}var St=s(24651);const Mt=new Map;function Ft(e,t,s){switch(v.QO.setAccountIndicator(e.MAIL_EMAIL,"INDICATOR_TYPE_FLUSHING",s.current,s.total),t.operation){case"BUFFER_OPERATION_CUSTOM_FLAG":return ta.updateFlags(e.MAIL_EMAIL,t.path,t.uids,t.flagUpdates);case"BUFFER_OPERATION_DELETE_IMAP":return ta.deleteMessages(e.MAIL_EMAIL,t.path,t.uids);case"BUFFER_OPERATION_DELETE_POP":return rt(e,t.searchListIds);case"BUFFER_OPERATION_MOVE":const{accountId:s,path:a,uids:n,destinationAccountId:i=t.accountId,destinationPath:o}=t;return s!==i?ta.moveMessagesBetweenAccounts(s,a,n,i,o):ta.moveMessages(s,t.path,t.uids,t.destinationPath);case"BUFFER_OPERATION_COPY":return ta.copyMessages(e.MAIL_EMAIL,t.path,t.uids,t.destinationPath);case"BUFFER_OPERATION_UPLOAD_MESSAGE":return ta.uploadMessage(e.MAIL_EMAIL,t.path,t.message,t.searchListId);default:return Promise.reject("Unknown batch operation '"+t.operation+"'")}}async function Rt(e,t){if(e.accountType===R.s9.IMAP){for(const s of t)"Inbox"!==s&&await ta.selectMailbox(e.MAIL_EMAIL,s);ta.park(e.MAIL_EMAIL)}}async function Tt(e){const t=await(0,wt.Z)(e);if(!t)return;const s=[];for(const e of t.sources)e[1].internal||s.push(e[0]);const a=await h.Z.filters.where("id").anyOf(s).toArray(),n=await h.Z.imap.where("searchListId").equals(e).toArray(),i=await h.Z.pop.where("searchListId").equals(e).toArray(),o=n.filter((e=>!e.hasRaw&&a.some((t=>t.accountId===e.accountId&&t.path===e.path)))),r=i.filter((e=>e.headersOnly&&a.some((t=>t.accountId===e.accountId)))),c=await It.Z.call(e);if(!c)throw new Error(`Message with id ${e} exists in searchList table but not in messages table`);for(const s of o){const{accountId:a,path:n}=s;v.U.setStatus(T.A4,(0,W.Z)("Fetching message with subject $1 on mail server $2",[t.subject,a]),3e3);let i=await ta.fetchRawOfMessage(a,n,e);i&&(i=await Fe(e,i),await ke.Z.call(a,c.sentDate,e,i),await(0,St.h)(a,e))}for(const t of r){const{accountId:s,uidl:a}=t,n=await K.Z.loadAccount(s);let i=await ct(n,a,c);i=await Fe(e,i),await ke.Z.call(s,c.sentDate,e,i),await h.Z.pop.update([s,a],{headersOnly:!1})}}const Ut=new Map;function _t(e,t){return C.Z.adjustBatchSize(100,1e3,500,e,t)}const Pt=(0,vt.Z)((async()=>{const e=await K.Z.loadAllAccounts();await async function(){const e=await h.Z.buffer.where("operation").equals("BUFFER_OPERATION_REMOVE_ACCOUNT").toArray();for(const t of e){const{accountId:e,deleteFiles:s}=t;await bt(e,s),Lt(e)}}(),await async function(){const e=await h.Z.buffer.where("operation").equals("BUFFER_OPERATION_REMOVE_ACCOUNT_PATH").toArray();for(const t of e){const{accountId:e,path:s,deleteFiles:a}=t;await Zt(e,s,a)}}(),e.forEach((e=>{const{MAIL_EMAIL:t}=e;void 0===Mt.get(t)&&Nt(e)})),await async function(){const e=await h.Z.buffer.where("operation").equals("BUFFER_OPERATION_FETCH_RAW_FOR_ALL_SOURCES").toArray();for(const t of e)await Tt(t.searchListId);if(e.length>0){const t=e.map((e=>e._id));gt.byIds(t);const s=e.map((e=>e.searchListId));v.QO.runStoredQueryFilters(s)}}()}),1e3);async function Nt(e,t=[]){if(e.offline)return;const{MAIL_EMAIL:s}=e,a=Mt.get(s)||0;Mt.set(s,a);try{let n;if(await h.Z.buffer.where("accountId").equals(s).offset(a).limit(1).modify((e=>{e.isFlushing=!0,n=e})),!n)return Mt.set(s,void 0),v.QO.removeAccountIndicator(s,"INDICATOR_TYPE_FLUSHING"),Rt(e,t),void Ut.delete(s);const i="BUFFER_OPERATION_DELETE_POP"===n.operation?R.Gf:n.path;if(!await z.Z.getFolderByPath(s,i))return console.warn("Removing batch for a path that does no longer exist",s,i),await h.Z.buffer.where("_id").equals(n._id).delete(),void await Promise.resolve().then((()=>Nt(e,t)));t.push(i),n.destinationPath&&t.push(n.destinationPath);const o=Ut.get(s)||_t(100,500);if(void 0!==n.uids&&n.uids.length>o){const{uids:t}=n,{current:i=0,total:r=t.length}=n,c={current:i,total:r},d=t.slice(0,o),l={...n,uids:d},u=Date.now();try{await Ft(e,l,c);const t=new Set(d);await h.Z.buffer.where("_id").equals(n._id).modify((function(e){e.uids=e.uids.filter((e=>!t.has(e))),e.uids.length>0?(e.current=i+d.length,e.total=r,e.isFlushing=!1):delete this.value}));const a=_t(o,Date.now()-u);Ut.set(s,a)}catch(e){Mt.set(s,a+1),console.error(e),await h.Z.buffer.where("_id").equals(n._id).modify({isFlushing:!1})}}else{let t;t="BUFFER_OPERATION_DELETE_POP"===n.operation?{current:n.searchListIds.length,total:n.searchListIds.length}:{current:1,total:1};try{if(await Ft(e,n,t),void 0!==n.uids){const e=new Set(n.uids);await h.Z.buffer.where("_id").equals(n._id).modify((function(t){t.isFlushing=!1,t.uids=t.uids.filter((t=>!e.has(t))),0===t.uids.length&&delete this.value}))}else await h.Z.buffer.where("_id").equals(n._id).delete()}catch(e){Mt.set(s,a+1),console.error(e),await h.Z.buffer.where("_id").equals(n._id).modify({isFlushing:!1})}}await Promise.resolve().then((()=>Nt(e,t)))}catch(a){console.error(a),Mt.set(s,void 0),v.QO.removeAccountIndicator(s,"INDICATOR_TYPE_FLUSHING"),Rt(e,t)}}const Ct={call:function(){navigator.onLine&&Pt()}};async function xt(e,t,s){const a=[],n=[],i=new Map,o=g.Z.getByFolderId([e,t]);return s.forEach((s=>{const{uid:a}=s;n.push([e,t,a]),i.set(a,s)})),await h.Z.transaction("rw",[h.Z.imap,h.Z.searchList,h.Z.filteringQueue,h.Z.buffer],(async()=>{const s=await h.Z.imap.where("[accountId+path+uid]").anyOf(n).toArray(),r=new Map;s.forEach((e=>{const{searchListId:t,uid:s}=e,a=i.get(s);if(!a)throw new Error("imapMessage not found");r.set(t,a)}));const c=[],d=[],l=[],u=[];await h.Z.searchList.where("id").anyOf([...r.keys()]).modify((s=>{const{id:n,unseen:i,flags:f}=s,h=r.get(n),p={},w={sources:new Map},I=(0,O.jw)(h.flags);p.sources=new Map;const y=(0,O.QE)(f,I);Object.keys(y).length>0&&(!function(e,t){delete t[R.T4.RECENT];const s=u.find((e=>(0,O.ui)(e.imapFlagUpdates,t)));s?s.searchListIds.push(e):u.push({searchListIds:[e],imapFlagUpdates:t})}(n,y),p.flags=s.flags=I,(0,O.wh)(f,h.flags,n,l),(0,O.Oj)(f,h.flags,n,d));const m=s.sources.get(o.id);if(!m)throw new Error("Source not found for "+e+", "+t);const L=!(0,O.FL)(h),v={};m.read!==L&&(i&&L&&(s.unseen=p.unseen=w.unseen=!1),m.read=v.read=L);for(const[t,a]of s.sources)if(a.internal){const s=g.Z.get(t)?.accountId;t!==o.id&&s===e&&L!==a.read&&(a.read=L,p.sources.set(t,{read:L}))}const E=(0,O.uY)(h);if(m.deleted!==E&&(m.deleted=v.deleted=E),Object.keys(v).length>0&&(p.sources.set(o.id,v),w.sources.set(o.id,v)),!E){const a=X.Z.getFolderType(e,t);if(![R.uT,R.Hd,R.hn].includes(a)){[...s.sources.keys()].forEach((t=>{const a=s.sources.get(t);if(!a)throw new Error("Source not found "+t);if(a.internal&&a.deleted){const a=g.Z.get(t);if(!a)throw new Error("Filter not found "+t);a.accountId===e&&(s.sources.delete(t),p.sources.set(t,void 0),w.sources.set(t,void 0))}}))}}if((Object.keys(p).length>1||p.sources.size>0)&&a.push({id:n,updates:p}),Object.keys(w).length>1||w.sources.size>0){const e=c.find((e=>{const{updates:t}=e;if(t.unseen!==w.unseen)return!1;const s=[...t.sources.keys()],a=[...w.sources.keys()];return s.length===a.length&&s.every((e=>w.sources.has(e)))}));e?e.searchListIds.push(n):c.push({updates:w,searchListIds:[n]})}}));for(const e of c){const{searchListIds:t,updates:s}=e;if(s.sources.size>0){const e=[[R.of,R.cm],[R.of,R.tB],[R.of,R.rp],[R.of,R.$T]];await m.Z.call({type:"FILTERS_SLES",priority:R.Un.HIGH,folderIds:e,searchListIds:t})}}for(const e of l){const{searchListIds:t,oldStandardFlag:s,newStandardFlag:a}=e,n=[];s&&n.push([R.MN,s]),a&&n.push([R.MN,a]),n.length>0&&await m.Z.call({type:"FILTERS_SLES",priority:R.Un.HIGH,folderIds:n,searchListIds:[...t]})}for(const e of d){const{searchListIds:t,flag:s}=e,a=[[R.ut,s]];await m.Z.call({type:"FILTERS_SLES",priority:R.Un.HIGH,folderIds:a,searchListIds:[...t],runLabels:!0})}for(const e of c){const{searchListIds:t,updates:s}=e;await m.Z.call({type:"UPDATE_SLE",priority:R.Un.HIGH,searchListIds:t,...s})}if(u.length>0){for(const{searchListIds:t,imapFlagUpdates:s}of u)await pt.Z.call(t,s,e);Ct.call()}})),a}var kt=s(89846);async function Dt(e,t){return await h.Z.transaction("rw",[h.Z.searchList,h.Z.messages,h.Z.threading],(async()=>{const s=(await h.Z.searchList.where("messageId").equals(e).toArray()).map((e=>e.id));await h.Z.searchList.where("id").anyOf(s).modify((e=>e.messageId=t)),await h.Z.messages.where("id").anyOf(s).modify((e=>e.messageId=t)),await h.Z.threading.where("id").anyOf(s).modify((e=>e.messageId=t))}))}async function Vt(e,t,s,a){return h.Z.transaction("rw",G.E.concat([h.Z.imap,h.Z.accounts,h.Z.filters,h.Z.searchList,h.Z.filteringQueue,h.Z.buffer]),(async()=>{const n=[],i=[],o=[],r={};for(const e of a)if(e.originalMessageId){const t=e.originalMessageId;r[t]=e.messageId,await Dt(t,e.messageId)}if(Object.keys(r).length>0)for(const e of a)r[e.messageId]&&(e.messageId=r[e.messageId]);const c=a.filter((e=>!!e.messageId)).map((e=>e.messageId)),d=await h.Z.searchList.where("messageId").anyOf(c).toArray(),l=await async function(e,t,s,a){if(0===e.length)return{intact:a,newImapEntries:[],sleUpdates:[]};const n={},i=await z.Z.getFolderByPath(t,s);if(!i)throw new Error(`${s} not found in db.accounts table for ${t}`);const o=i.type,r={};a.forEach((e=>{r[e.messageId]||(r[e.messageId]=[]),r[e.messageId].push(e)}));const c=g.Z.getByFolderId([t,s]),d=[];for(const a of e){const{sourceFilterIds:e,sources:i}=a,l=i.get(c.id);if(!l||!l.internal)continue;const u=g.Z.getByIds(e);let f,h;for(const e of u){const{accountId:a,path:n}=e,i=a===t&&n===s;if(a===R.of&&n===R.N1&&o===R.Nz||i){f=a,h=n;break}}if(!f)continue;if(!h)continue;const p=r[a.messageId],w=p.findIndex((e=>e.sentDate===a.sentDate&&e.subject===a.subject));if(w>=0){const[e]=p.splice(w,1);n[a.id]=e.uid;const{sleUpdate:i}=await(0,kt.Z)(a.id,f,h,t,s,{addedProperties:{searchListSource:{internal:!1}}});d.push([i,e.size])}}const l=[],u=[];for(const[e,a]of d)u.push(e),l.push({accountId:t,path:s,uid:n[e.id],searchListId:e.id,size:a||0,hasRaw:0});return{intact:a.filter((e=>r[e.messageId].some((t=>t.uid===e.uid)))),newImapEntries:l,sleUpdates:u}}(d,e,t,a),{intact:u,newImapEntries:f,sleUpdates:p}=l;if(n.push(...f),o.push(...p),0===u.length){await h.Z.imap.bulkPut(n);const s=await xt(e,t,a);return o.push(...s),{sleUpdates:o}}const{newGroups:w,duplicates:I}=(0,J.R)(e,u,d);for(const s of I){const{message:a,searchListEntry:i}=s,o={accountId:e,path:t,uid:a.uid,searchListId:i.id,hasRaw:0,size:a.size||0};n.push(o)}const y=w.map((e=>e[0]));if((await(0,G.Z)(e,t,s,y)).forEach(((s,a)=>{w[a].forEach((a=>{n.push({accountId:e,path:t,uid:a.uid,searchListId:s.id,hasRaw:0,size:a.size||0})})),i.push(s)})),n.length!==a.length)throw new Error("Assert error in addImap: expected imapEntries to match imapMessages");const m=await h.Z.imap.where("searchListId").anyOf(n.map((e=>e.searchListId))).toArray(),L=0===m.length?n:n.filter((e=>{const t=ht()(m,e,le.gE);if(t>=0)return!1;let s=!1,a=-t-1;for(;m[a]&&m[a].searchListId===e.searchListId&&m[a].accountId===e.accountId;){if(m[a].hasRaw){s=!0;break}a++}if(!s)for(a=-t-2;m[a]&&m[a].searchListId===e.searchListId&&m[a].accountId===e.accountId;){if(m[a].hasRaw){s=!0;break}a--}return e.hasRaw=s?1:0,!0}));await h.Z.imap.bulkAdd(L);const v=new Set(f.map((e=>e.uid))),E=a.filter((e=>v.has(e.uid))),Z=await xt(e,t,E);if(o.push(...Z),I.length>0){const a=await(0,J.y)(e,t,s,I,!1);o.push(...a)}return{addedSles:i,sleUpdates:o}}))}var $t=s(9982),Bt=s(42315),Qt=s(26067);function jt(e,t,s){const{pathArray:a,fileName:n}=(0,Qt.Z)(e,t,s);return new Promise((e=>{l.Z.mailPrivate.messageFileExists(a,n,(t=>{o.Z.runtime.lastError?e(!1):e(t)}))}))}const zt=async function(e,t){const s=[],a=e.map((e=>e.searchListId));return h.Z.imap.bulkAdd(e),await h.Z.searchList.where("id").anyOf(a).modify((e=>{const{id:a}=e,n={sources:new Map},i=e.sources.get(t.id);if(i)i.internal=!1,n.sources.set(t.id,{...i});else{const s={read:!1,deleted:!1,internal:!1};e.sources.set(t.id,s),n.sources.set(t.id,{...s})}s.push({id:a,updates:n})})),s};const qt=async function(e,t,s){await h.Z.buffer.where("[accountId+path+operation]").equals([e,t,"BUFFER_OPERATION_CUSTOM_FLAG"]).modify((function(e){const{uids:t,flagUpdates:a}=e,n=new Set(t);s.forEach((e=>{Object.keys(a).every((t=>a[t]?e.flags.includes(t):!e.flags.includes(t)))&&n.delete(e.uid)})),0===n.size?delete this.value:e.uids=[...n]}))};function Wt(e){return h.Z.imap.where("[hasRaw+accountId+searchListId]").between([0,e,0],[0,e,1/0]).toArray().then(Kt)}function Kt(e){let t;return e.filter(((s,a)=>{const n=t?.searchListId===s.searchListId,i=e[a+1],o=s.searchListId===i?.searchListId&&t?.path===i?.path;return!n&&!o&&(t=s,!0)}))}var Ht=s(83507);const Gt=async function(e){const{id:t,sources:s,sentDate:a}=e;if(0===s.size)return!1;if(![...s.values()].every((e=>e.deleted&&e.internal)))return!0;const n=new Set,i=g.Z.getByIds([...s.keys()]);for(const e of i)n.add(e.accountId);for(const e of n){if(await Ht.Z.call(e,t,a))return!0}return!1};var Jt=s(93043);function Yt(e){const t=[];return e.forEach((e=>{const[s,a]=e;for(let e=s;e<=a;e++)t.push(e)})),t}function Xt(e,t){for(let s=0;s<t.length;s++){const a=t[s],[n,i]=a;if(e<n)return void(e===n-1?a[0]=e:t.splice(s,0,[e,e]));if(e>=n&&e<=i)return;if(e===i+1){if(a[1]=e,s<t.length-1){const[n]=t[s+1];if(e===n-1){const[e]=t.splice(s+1,1),[,n]=e;a[1]=n}}return}}t.push([e,e])}function es(e){const t=e.split(","),s=[];return t.forEach((e=>{if(e.indexOf(":")>=0){const[t,a]=e.split(":"),n=Number.parseInt(t),i=Number.parseInt(a),o=[];if(n<i)for(let e=n;e<=i;e++)o.push(e);else for(let e=i;e<=n;e++)o.push(e);s.push(...o.sort())}else{const t=Number.parseInt(e);s.push(t)}})),s}var ts=s(89555);let ss,as,ns,is={};function os(){ss=new Promise(((e,t)=>{as=e,ns=t})),ss.catch(ts.default)}function rs(){return h.Z.imap.orderBy("[accountId+path+uid]").primaryKeys().then((e=>{e.forEach((e=>{const[t,s,a]=e;is[t]||(is[t]={}),is[t][s]||(is[t][s]=[]),Xt(a,is[t][s])})),as()})).catch((e=>{throw ns(e),e}))}function cs(e){return ss.then((()=>function(e){const t=new Set;return z.Z.getFolder(e).then((e=>(Object.keys(e).forEach((s=>{e[s].forEach((e=>{t.add(e.path)}))})),t)))}(e))).then((t=>h.Z.mailboxCache.where("accountId").equals(e).toArray().then((s=>{const a=is[e]||{},n={};return s.forEach((e=>{n[e.path]=e,n[e.path].uidlist=a[e.path]?Yt(a[e.path]):[],n[e.path].exists=n[e.path].uidlist.length,n[e.path].highestModseq=n[e.path].highestModseq||"0",t.delete(e.path),n[e.path].noModseq=n[e.path].noModseq||!1})),t.forEach((e=>{const t=Yt(a[e]||[]),s=t.length>0?t[t.length-1]+1:0;n[e]={uidlist:t,uidNext:s,exists:t.length}})),n}))))}os();const ds={},ls={},us=new Set,fs=new Map,hs=new Map,ps=18e5,ws=9e5,gs={},Is={},ys=new Set;let ms,Ls=!1,vs=0;const Es=new class{_isProcessing=!1;constructor(e){this._priorityQueue=[];for(let t=0;t<e;t++)this._priorityQueue.push([])}queue(e,t,...s){return new Promise(((a,n)=>{this._priorityQueue[t].push({func:e,resolve:a,reject:n,params:s}),this._isProcessing||this._processQueue()}))}async _processQueue(){for(this._isProcessing=!0;await this._runNextInLine(););this._isProcessing=!1}async _runNextInLine(){for(const e of this._priorityQueue){const t=e.shift();if(t){const{func:e,resolve:s,reject:a,params:n}=t;try{s(await e(...n))}catch(e){a(e)}return!0}}return!1}}(Object.keys(R.NB).length);let Zs=!1;function bs(e){if(!navigator.onLine){const e=(0,W.Z)("No network connection");throw new Error(e)}if(a.Z.get(F.kMailIsTurnedOff))throw new Error((0,W.Z)("Mail has been turned off"));const t=(a.Z.get(F.kMailAccounts)||[]).find((t=>t.MAIL_EMAIL===e));if(!t)throw new Error((0,W.Z)("Account has been deleted"));if(t.offline)throw new Error((0,W.Z)("Account is offline"));const s=ds[e];if(s)return s;if(ls[e])throw(0,W.Z)("Is logging into mail account $1",[e]);throw v.U.setStatus(T.A4,(0,W.Z)("Reconnecting $1",[e])),Ws(e),(0,W.Z)("Not connected to $1 - Attempting to connect",[e])}function As(e){e!==R.of&&(us.add(e),Ss())}function Os(e){u.ZP.error("Mail",["imap"],e)}const Ss=(0,vt.Z)((async()=>{const e=[...us];us.clear();for(const t of e){const[e]=X.Z.getPathsByType(t,R.e9);if(!e)return void u.ZP.warn("Mail",["imap"],"No inbox found to park in on account "+t);if(ds[t])try{Ms(t,e,!0)}catch(e){Os(e)}}}),2e3);function Ms(e,t,s=!1){if(!navigator.onLine)return Promise.reject((0,W.Z)("No network connection"));gs[e]||(gs[e]=[]);const a=gs[e];return new Promise(((i,o)=>{s?0!==a.length&&a[0].path===t||a.unshift({path:t,resolve:i,reject:o}):a.find((e=>e.path===t))||a.push({path:t,resolve:i,reject:o}),Is[e]||(Is[e]=!0,n())}));async function n(){const t=gs[e];if(!t||t.length<=0)return void(Is[e]=!1);const{path:s,resolve:a,reject:i}=t.pop();try{const t=bs(e),i=t.selectMailbox({path:s});qs(e,t),await i,a()}catch(e){i(e)}finally{v.QO.removePathIndicator(e,s,"INDICATOR_TYPE_FETCHING"),n()}}}async function Fs(e,t,s){const a={path:t,uids:s},n=bs(e),i=await n.deleteMessages(a);return qs(e,n),i}async function Rs(e,t,s){const a=await h.Z.imap.where("searchListId").equals(s).filter((s=>s.accountId===e&&s.path===t)).toArray();if(0===a.length)return;return(await Es.queue(Us,R.NB.FETCH_RAW,e,a)).get(s)}async function Ts(e,t){const s=await Us(e,t),a=await(n=Array.from(s.keys()),h.Z.messages.where("id").anyOf(n).toArray());var n;const i=new Map;for(const e of a)i.set(e.id,e);let o=0;for(const[a,n]of s){const s=i.get(a);if(s){const{sentDate:t}=s,i=await Fe(a,n);await ke.Z.call(e,t,a,i)}else{const s=t.find((({searchListId:e})=>e===a));if(s){const{path:t,uid:n}=s;u.ZP.warn("Mail",["imap"],`fetchRawFromImapEntries: Expected message ${a} to exist, deleting imap entry ${e}/${t}/${n}`),await h.Z.imap.delete([e,t,n])}}o+=await(0,St.h)(e,a)}return o}async function Us(e,t){const s=new Map;if(0===t.length)return s;if(!navigator.onLine)throw new Error((0,W.Z)("No network connection"));const a=new Map;let n=t[0].path;try{const i={accountId:"",path:"",hasRaw:0,searchListId:-1,size:0,uid:-1};for(const o of[...t,i]){if(n!==o.path){const t=Array.from(a.keys()),i=bs(e),o=i.getMessages({path:n,uids:t});qs(e,i);const r=await o;Object.keys(r).forEach((t=>{const i=a.get(parseInt(t));i?r[t]?s.set(i,r[t]):Os(`Expected to find raw for ${e}/${n}/${t}`):Os(`Un-expected uid ${e}/${n}/${t}`)})),a.clear()}n=o.path,a.set(o.uid,o.searchListId)}return As(e),s}catch(e){throw v.U.setStatus(T.A4,(0,W.Z)("Failed to get message body - $1",[e])),u.ZP.warn("Mail",["imap"],"Fetch raw",e),e}}async function _s(e,t,s,a,n){for(const i of s)await Ps(e,t,i,a,n)}async function Ps(e,t,s,a,n){if(!navigator.onLine)throw new Error((0,W.Z)("No network connection"));let i=!1;const o=await h.Z.imap.get([e,t,s]);if(!o)throw new Error(`Imap entry not found for ${e} ${t} ${s}`);const{searchListId:r}=o,c=await h.Z.messages.get(r);o.hasRaw||await Us(e,[o]);const d=await Ht.Z.call(e,r,c.sentDate);if(!d)throw new Error(`Raw message not found on disk: ${e}, ${c.sentDate}, ${r}`);const l=(0,xe.Z)(d);try{await Ns(a,n,l,r),i=!0,await Fs(e,t,[o.uid])}catch(s){if(!i)throw s;{const s={accountId:e,path:t,uids:[o.uid],operation:"BUFFER_OPERATION_DELETE_IMAP"};try{await h.Z.buffer.add(s)}catch(t){u.ZP.error("Mail",["imap","move"],`Message ${c.subject} was uploaded to destination server ${a} but was not removed from source server ${e}`)}}}}async function Ns(e,t,s,a){const n=[e,t],i=g.Z.getByFolderId(n);if(!i)throw new Error("Destination filter not found for "+n.join(", "));const o=bs(e),r=o.uploadMessage({path:t,message:s});qs(e,o);const c=await r;if(As(e),!c)return void u.ZP.warn("Mail",["imap"],"UIDPLUS not supported, cannot create imap entry");const d=Number.parseInt(c);let l;await h.Z.transaction("rw",[h.Z.imap,h.Z.searchList],(async()=>{const n={accountId:e,path:t,uid:d,searchListId:a,size:s.length,hasRaw:1};l=await zt([n],i)})),l&&v.QO.updateIndex({sleUpdates:l})}async function Cs(e,t,s,a,n){if(!navigator.onLine)throw new Error((0,W.Z)("No network connection"));const i=bs(e),o=i.listMessages({path:t,uids:s});qs(e,i);const r=await o;await(0,$t.Z)(e,t,r);const c=X.Z.getFolderType(e,t),d=await Vt(e,t,c,r);ms=!1,v.QO.updateIndex(d),ve.filter(),Ce.updateThreads();const{addedSles:l,sleUpdates:u}=d;if((l&&l.length>0||u&&u.length>0)&&(v.U.setStatus(T.A4,(0,W.Z)("Indexing mail $1 $2 $3/$4",[e,t,n,a])),v.QO.setPathIndicator(e,t,"INDICATOR_TYPE_FETCHING",R.NB.SYNC_NEW_DELETED,n,a)),u&&u.length>0){const t=[];for(const s of u){const{sources:a}=s.updates;if(a){if(Array.from(a.values()).some((e=>e&&!1===e.internal))){const a=await(0,wt.Z)(s.id);if(a){const n=s.id;await jt(e,a.sentDate,n)&&t.push([0,e,n])}}}}t.length>0&&await h.Z.imap.where("[hasRaw+accountId+searchListId]").anyOf(t).modify({hasRaw:1})}!function(e,t,s){is[e]||(is[e]={}),is[e][t]?s.forEach((s=>{Xt(s,is[e][t])})):is[e][t]=function(e){const t=[];if(0===e.length)return t;let s;for(let a=0;a<e.length;a++){const n=e[a],i=e[a-1];0===a?s=[n,n]:s&&n-i>1&&(s[1]=i,t.push(s),s=[n,n]),s&&a===e.length-1&&(s[1]=n,t.push(s))}return t}(s)}(e,t,r.map((e=>e.uid)))}function xs(e){if(a.Z.get(F.kMailIsTurnedOff))return!1;const t=(a.Z.get(F.kMailAccounts)||[]).find((t=>t.MAIL_EMAIL===e));return!!t&&!t.offline}function ks(e){if(a.Z.get(F.kMailIsTurnedOff))return!1;const t=(a.Z.get(F.kMailAccounts)||[]).find((t=>t.MAIL_EMAIL===e));return!!t&&!t.offline&&t.preFetch}async function Ds(e,t,s,a){const n=C.Z.adjustBatchSize.bind(void 0,10,1e3,500);let i=10,o=0;return new Promise(((r,c)=>{Es.queue((async function d(){if(!xs(e))return void r();const l=t.slice(o,o+i);if(0===l.length)return void r();const u=Date.now();try{await a(l,t.length,o),o+=i}catch(e){return void c(e)}const f=Date.now();i=n(i,f-u),Es.queue(d,s)}),s)}))}async function Vs(e,t){if(!navigator.onLine)throw new Error((0,W.Z)("No network connection"));v.U.setStatus(T.A4,(0,W.Z)("Indexing - $1 $2",[e,t.path]));const{list:s,path:a,type:n}=t;try{if("new"===n?(u.ZP.log("Mail",["imap"],"new messages received",e,a,s),s.reverse(),await Ds(e,s,R.NB.SYNC_NEW_DELETED,(async(t,s,n)=>{await Cs(e,a,t,s,n)})),await Ys(e)):"deleted"===n?(u.ZP.log("Mail",["imap"],"messages deleted on server",e,a,s),await Ds(e,s,R.NB.SYNC_NEW_DELETED,(async t=>{await async function(e,t,s){const a=s.map((s=>[e,t,s])),n=[],i=[],o=[],r=[],c=g.Z.getByFolderId([e,t]);await h.Z.transaction("rw",[h.Z.searchList,h.Z.messages,h.Z.buffer,h.Z.imap,h.Z.filteringQueue],(async()=>{await h.Z.imap.where("[accountId+path+uid]").anyOf(a).modify(((e,t)=>{n.push(e.searchListId),delete t.value})),await h.Z.searchList.where("id").anyOf(n).modify((s=>{const{id:a}=s,n={},d={sources:new Map};let l=!1;n.sources=new Map,s.flags.includes(R.T4.SEEN)||(s.flags.push(R.T4.SEEN),n.flags=s.flags,d.unseen=!1,d.unread=!1);const u=s.sources.get(c.id);if(u){const a=[R.uT,R.Hd,R.hn],i=X.Z.getFolderType(e,t),o=a.includes(i),r=[...s.sources.keys()].some((t=>{const s=g.Z.get(t);if(!s)throw new Error("Filter not found "+t);if(s.accountId!==e)return!1;const n=X.Z.getFolderType(s.accountId,s.path);return!a.includes(n)}));o&&r?(s.sources.delete(c.id),l=!0,d.sources.set(c.id,void 0),n.sources.set(c.id,void 0)):(u.deleted=!0,u.internal=!0,d.sources.set(c.id,{...u}),n.sources.set(c.id,{...u}))}const f=0===s.sources.size||[...s.sources.values()].every((e=>e.internal));f&&r.push(s),(Object.keys(n).length>1||n.sources.size>0)&&i.push({id:a,updates:n});const h=["unread","unseen"],p=o.find((e=>{if(l!==e.rerunFiltering)return!1;const{updates:t}=e,s=h.every((e=>t[e]===d[e])),a=[...t.sources.keys()],n=[...d.sources.keys()],i=a.length===n.length&&a.every((e=>d.sources.has(e)));return s&&i}));p?p.searchListIds.push(a):o.push({updates:d,searchListIds:[a],rerunFiltering:l})})),await gt.byUids(e,t,s);for(const e of o){const{searchListIds:t,updates:s,rerunFiltering:a}=e;a?await m.Z.call({type:"RE_RUN_SLES",priority:R.Un.NORMAL,searchListIds:t,folderIds:[[R.of,R.cm],[R.of,R.rp]]}):await m.Z.call({type:"FILTERS_SLES",priority:R.Un.NORMAL,searchListIds:t,folderIds:[[R.of,R.cm],[R.of,R.rp]]}),await m.Z.call({type:"UPDATE_SLE",priority:R.Un.NORMAL,searchListIds:t,...s})}}));const d=[];for(const e of r)if(!await Gt(e)){const{id:t}=e;d.push(t)}d.length>0&&await Jt.Z.call(d),await v.QO.updateIndex({sleUpdates:i,removedSles:d})}(e,a,t)}))):"messages"===n&&(u.ZP.log("Mail",["imap"],"flag updates from server",e,a,s),await Ds(e,s,R.NB.SYNC_FLAGS,(async(t,s,n)=>{await async function(e,t,s,a,n){await qt(e,t,s);const i=await xt(e,t,s);v.QO.updateIndex({sleUpdates:i}),v.U.setStatus(T.A4,(0,W.Z)("Updating flags $1 $2 $3/$4",[e,t,n,a])),v.QO.setPathIndicator(e,t,"INDICATOR_TYPE_FLAGS",R.NB.SYNC_FLAGS,n,a)}(e,a,t,s,n)}))),xs(e)){const t=bs(e);!function(e,t,s){"inbox"===t.toLowerCase()&&(t=R.Gf),ss.then((()=>h.Z.transaction("rw",h.Z.mailboxCache,(()=>{Object.keys(s).forEach((a=>{const n=s[a];a!==t&&0!==n.exists||h.Z.mailboxCache.put({accountId:e,path:a,uidNext:n.uidNext,highestModseq:n.highestModseq||"0",noModseq:n.noModseq||!1})}))}))))}(e,a,t.mailboxCache)}v.U.setStatus(T.A4,(0,W.Z)("Finished indexing - $1 $2",[e,a]),R.QM)}catch(e){Os(e),v.U.setStatus(T.A4,(0,W.Z)("Failed indexing - $1",[e]))}v.QO.removePathIndicator(e,a,"INDICATOR_TYPE_FETCHING"),v.QO.removePathIndicator(e,a,"INDICATOR_TYPE_FLAGS"),ve.filter()}function $s(e,t){if("AUTHENTICATIONFAILED"===t.code)vs=0,v.U.setStatus(T.A4,(0,W.Z)("$1: Authentication failed. Check username and password",[e])),v.QO.setDisconnected(e,!0,t.message||t);else{t.code?v.U.setStatus(T.A4,`[${t.code}] ${t.message||t}`):v.U.setStatus(T.A4,`${t.message||t}`);const s=function(e){if(++vs<=5)return 2e3*vs;let t=fs.get(e);t=void 0===t?6e4:Math.min(t+ws,ps),fs.set(e,t);const s=Math.floor(1e3*Math.random()*6-3e3);return t+s}(e);Ws(e,s,t.message||t)}}async function Bs(){const e=await K.Z.loadImapAccounts();e?e.forEach(Qs):u.ZP.warn("Mail",["imap"],"No IMAP accounts found!")}async function Qs(e){if(e.isDeleted||e.offline)return;const t=e.MAIL_EMAIL;if(!navigator.onLine)return void v.QO.setDisconnected(t,!0,"No network connection");if(!e.MAIL_PORT||e.MAIL_PORT<=0)throw new Error(`Port missing or invalid: ${e.MAIL_PORT||""}`);const s=await Bt.Z.getIMAPClient(e);if(ds[t]||ls[t])u.ZP.log("Mail",["imap"],"Already connected or being connected",t);else{ls[t]=s,v.QO.setConnecting(t,!0),v.QO.setAccountIndicator(t,"INDICATOR_TYPE_CONNECTING");try{s.onSyncUpdate=Vs.bind(null,t),s.onError=e=>{$s(t,e)};const e=await cs(t);s.mailboxCache=e||{},await s.login(),u.ZP.info("Mail",["imap"],"Connected to",t),v.U.setStatus(T.A4,(0,W.Z)("Connected to $1",[t]));const a=await s.listWellKnownFolders(),n=s._client._capability;a.Inbox&&a.Inbox.forEach((e=>{"inbox"===e.path.toLowerCase()&&(e.path=R.Gf)})),await z.Z.add(t,a,n),await q.Z.addAccounts({[t]:{folders:a,capability:n}});const i=await f.Z.foldersToFilters(t,a);g.Z.updateFilters(i),re.Z.addFolders(t,a),ds[t]=s,delete ls[t],fs.delete(t),Ks(t),vs=0,v.QO.setDisconnected(t,!1),Ct.call()}catch(e){$s(t,e)}finally{v.QO.setConnecting(t,!1),v.QO.removeAccountIndicator(t,"INDICATOR_TYPE_CONNECTING")}try{await Gs(t),Ys(t)}catch(e){Os(e)}}}function js(){for(const e of[...Object.keys(ls),...Object.keys(ds)])zs(e)}function zs(e,t){const s=ds[e]||ls[e];if(s)try{s.onSyncUpdate=!1,s.onError=ts.default,s.logout(),u.ZP.info("Mail",["imap"],"Disconnected from",e)}catch(t){Os(t)}v.QO.setDisconnected(e,!0,t),delete ds[e],delete ls[e],delete gs[e],delete Is[e],Ks(e),v.QO.removeAllIndicators(e)}function qs(e,t){if(ds[e]!==t)throw(0,W.Z)("This client is no longer connected to account $1",[e])}function Ws(e,t,s){function n(){K.Z.loadImapAccounts().then((t=>{const s=t.find((t=>t.MAIL_EMAIL===e));s&&Qs(s)}))}a.Z.get(F.kMailIsTurnedOff)||(zs(e,s),t?function(e,t,s){if(hs.has(s))return;const a=setTimeout(e,t);hs.set(s,a)}(n,t,e):n())}function Ks(e){const t=hs.get(e);void 0!==t&&(clearTimeout(t),hs.delete(e))}function Hs(){return 0===Object.keys(ds).length}function Gs(e){if(Hs()||e&&!ds[e])return Promise.resolve();let t;return t=e?z.Z.getFolder(e).then((t=>({[e]:{folders:t}}))):K.Z.loadImapAccounts().then((e=>z.Z.getAll().then((t=>{const s={};for(let a=0;a<e.length;a++){const n=e[a],i=t.find((e=>n.MAIL_EMAIL===e.accountId));i&&(s[i.accountId]={folders:i.folders})}return s})))),t.then((e=>{const t=ut.Z.getFolders(e,!1);Promise.all(t.map((e=>{const t=e.accountId,a=e.children;if(!a||a.length<=0)return Promise.resolve();a.sort(((e,t)=>e.type===t.type?0:"Inbox"===e.type?1:"Inbox"===t.type?-1:"All"===e.type?1:"All"===t.type?-1:0)),Promise.all(s(t,a)).catch(Os).then((()=>As(t)))})))}));function s(e,t){let a=[];for(const n of t)n.subscribed&&a.push(Ms(e,n.path)),n.children&&(a=a.concat(s(e,n.children)));return a}}function Js(e){Hs()||e&&!ds[e]?Bs():Gs(e)}function Ys(e){ys.add(e),Xs()}function Xs(){if(Ls)return;Ls=!0;const e=[...ys];ys.clear(),e.reduce(((e,t)=>e.then((()=>async function(e){let t,s=!1,a=0;ms=!1;for(;ks(e);){const t=await Wt(e);if(0===t.length)break;let s=0;for(;s<t.length;)s=await Es.queue(n,R.NB.PRE_FETCH,t,s)}async function n(n,i){if(!ks(e))return n.length;const o=n[i++],r=[o];let c=o.size,d=c?0:1;const l=32768,u=10;for(;i<n.length&&c<l&&d<u;){const e=n[i++];r.push(e),e.size?c+=e.size:d++}const f=await Ts(e,r);return s=!0,a+=f,ms||(t=await function(e){return h.Z.imap.where("[hasRaw+accountId+searchListId]").between([0,e,0],[0,e,1/0]).count()}(e)+a,ms=!0),v.U.setStatus(T.A4,(0,W.Z)("Prefetching - $1 $2/$3",[e,a,t])),v.QO.setAccountIndicator(e,"INDICATOR_TYPE_PRE_FETCHING",R.NB.PRE_FETCH,a,t),v.QO.runStoredQueryFilters(r.map((e=>e.searchListId))),i}s&&(v.QO.removeAccountIndicator(e,"INDICATOR_TYPE_PRE_FETCHING"),v.U.setStatus(T.A4,(0,W.Z)("Finished prefetching - $1",[e])))}(t).catch((e=>{v.U.setStatus(T.A4,(0,W.Z)("Error prefetching - $1",[t])),v.QO.removeAllIndicators(t),Os(`Error prefetching ${t} ${e}`)}))))),Promise.resolve()).then((()=>{Ls=!1,ys.size>0&&Xs()}))}const ea={setCheckInterval:function(e,t){Zs&&clearInterval(Zs),Zs=!!e&&setInterval(Gs,6e4*t)},fetchRawOfMessage:Rs,connectIMAPClient:Qs,connectIMAPClients:Bs,disconnectIMAPClient:zs,reconnectIMAPClient:Ws,reconnectIMAPClients:function(){a.Z.get(F.kMailIsTurnedOff)||(js(),Bs())},disconnectIMAPClients:js,checkNewDeletedModified:function(e,t){Ms(e,t).catch(Os).then((()=>As(e)))},rescanUnreadFlags:function(e,t){const s=bs(e).mailboxCache[t];s&&(s.highestModseq="0",Ms(e,t).catch(Os).then((()=>As(e))))},checkForMail:Js,preFetch:Ys,subscribeMailbox:async function(e,t){const s=bs(e),a=s.subscribeMailbox({path:t});qs(e,s),await a,Ws(e)},unsubscribeMailbox:async function(e,t,s){const a=bs(e),n=a.unsubscribeMailbox({path:t});qs(e,a),await n,s&&function(e,t){delete is[e][t]}(e,t),Ws(e)},createMailbox:async function(e,t){try{t=(0,S.y3)(t);const s=bs(e),a=async()=>{await s.createFolder({path:t}),await s.subscribeMailbox({path:t})};qs(e,s),await a(),Ws(e)}catch(e){u.ZP.error("Mail",["create mailbox"],e.message||e)}},deleteMailbox:async function(e,t){try{const s=bs(e),a=async()=>{await s.unsubscribeMailbox({path:t}),await Zt(e,t,!0),await s.deleteFolder({path:t})};qs(e,s),await a(),Ws(e)}catch(e){u.ZP.error("Mail",["delete mailbox",e.message||e])}},moveMessagesBetweenAccounts:_s};self.addEventListener("message",(async function({origin:e,data:t,source:s}){if(e!==T.oP||!t||!t.imap)return;const{promiseId:a,func:n,args:i=[]}=t.imap;if(n)try{const e=await ea[n](...i),t=e&&"fetchRawOfMessage"===n?[e.buffer]:void 0;s.postMessage({imap:{promiseId:a,results:e}},{transfer:t})}catch(e){const t=e.message||e;s.postMessage({imap:{promiseId:a,error:t}})}}),!1);const ta={checkForMail:Js,connectIMAPClient:Qs,copyMessages:async function(e,t,s,a){const n={path:t,uids:s,destination:a},i=[e,a],o=g.Z.getByFolderId(i);if(!o)throw new Error("Destination filter not found for "+i.join(", "));const r=await h.Z.imap.where("[accountId+path+uid]").anyOf(s.map((s=>[e,t,s]))).toArray(),c=new Map(r.map((e=>[e.uid,e]))),d=bs(e),l=d.copyMessages(n);qs(e,d);const f=await l;if(!f)return void u.ZP.warn("Mail",["imap"],"UIDPLUS not supported, cannot create imap entries");const{srcSeqSet:p,destSeqSet:w}=f,I=es(p),y=es(w);let m;await h.Z.transaction("rw",[h.Z.imap,h.Z.searchList],(async()=>{const s=[];I.forEach(((n,i)=>{const o=y[i],r=c.get(n);r?s.push({...r,path:a,uid:o}):u.ZP.warn("Mail",["imap"],"cannot create imap entry for "+JSON.stringify([e,t,n]))})),m=await zt(s,o)})),m&&v.QO.updateIndex({sleUpdates:m})},deleteMessages:Fs,disconnectIMAPClient:zs,fetchRawOfMessage:Rs,moveMessages:function(e,t,s,a){const n={path:t,uids:s,destination:a},i=bs(e),o=i.moveMessages(n);return qs(e,i),o},moveMessagesBetweenAccounts:_s,park:As,selectMailbox:Ms,updateFlags:function(e,t,s,a){const n=[],i=[];for(const[e,t]of Object.entries(a))t?n.push(e):i.push(e);const o={path:t,uids:s,add:n,remove:i},r=bs(e),c=r.updateFlags(o);return qs(e,r),c},uploadMessage:Ns};var sa=s(20570);const aa={call:async function(e){if(0===e.length)return;const t=[],s=new Map;e.forEach((e=>{const{id:a,updates:n}=e,{sources:i=new Map}=n;i.forEach((async(e,s)=>{if(!e||0===Object.keys(e).length)return;const n=g.Z.get(s);if(!n)throw new Error(`Source filter ${s} not found in cache`);const{accountId:i,path:o}=n;t.push([i,o,a])})),s.set(a,e)})),0!==t.length&&await h.Z.transaction("rw",[h.Z.buffer,h.Z.imap],(async()=>{const e=[];(await h.Z.imap.where("[accountId+path+searchListId]").anyOf(t).toArray()).forEach((t=>{const{accountId:a,path:n,uid:i,searchListId:o}=t,r=s.get(o),c=g.Z.getByFolderId([a,n]),{sources:d}=r.updates;if(d){const t=d.get(c.id),s={},{deleted:o,read:r}=t;void 0!==o&&(s[R.T4.DELETED]=o),void 0!==r&&(s[R.T4.SEEN]=r),e.push({accountId:a,path:n,uid:i,flagUpdates:s})}})),e.length>0&&await sa.Z.addCustomFlags(e)}))}};const na={call:async function(e,t){const s=new Map,a=[];for(const t of e)s.set(t.searchListId,t);return await h.Z.transaction("rw",[h.Z.searchList,h.Z.filteringQueue],(async()=>{const e=[],n=[],i=[];await h.Z.searchList.where("id").anyOf([...s.keys()]).modify((o=>{const{id:r,unseen:c,flags:d,sources:l}=o,u=s.get(r);if(!u)return;const f={},h={sources:new Map},p=(0,O.hY)(d,t),w=(0,O.jw)(p);if((0,O.W5)(d,w)||(f.flags=o.flags=w,(0,O.wh)(d,p,r,n),(0,O.Oj)(d,p,r,i)),f.sources=new Map,u.sources&&u.sources.forEach(((e,t)=>{const s=l.get(t);if(s){for(const t of Object.keys(e))e[t]!==s[t]&&"read"===t&&c&&!0===e[t]&&(f.unseen=h.unseen=o.unseen=!1);l.set(t,{...s,...e}),f.sources.set(t,e),h.sources.set(t,e)}})),(Object.keys(f).length>1||f.sources.size>0)&&a.push({id:r,updates:f}),void 0!==h.unseen||h.sources.size>0){const t=e.find((e=>{const{updates:t}=e;if(t.unseen!==h.unseen)return!1;const s=[...t.sources.keys()],a=[...h.sources.keys()];return s.length===a.length&&s.every((e=>h.sources.has(e)))}));t?t.searchListIds.push(r):e.push({updates:h,searchListIds:[r]})}}));for(const t of e){const{searchListIds:e,updates:s}=t;if(s.sources.size>0){const t=[[R.of,R.cm],[R.of,R.tB],[R.of,R.rp]];await m.Z.call({type:"FILTERS_SLES",priority:R.Un.HIGH,folderIds:t,searchListIds:e})}}for(const e of n){const{searchListIds:t,oldStandardFlag:s,newStandardFlag:a}=e,n=[];s&&n.push([R.MN,s]),a&&n.push([R.MN,a]),n.length>0&&await m.Z.call({type:"FILTERS_SLES",priority:R.Un.HIGH,folderIds:n,searchListIds:[...t]})}for(const e of i){const{searchListIds:t,flag:s}=e,a=[[R.ut,s]];await m.Z.call({type:"FILTERS_SLES",priority:R.Un.HIGH,folderIds:a,searchListIds:[...t]})}for(const t of e){const{searchListIds:e,updates:s}=t;await m.Z.call({type:"UPDATE_SLE",priority:R.Un.HIGH,searchListIds:e,...s})}})),a}};let ia=!1;const oa=C.Z.adjustBatchSize.bind(void 0,100,1e3,500);let ra=100;async function ca(e){const t=await h.Z.flaggingQueue.toCollection().first();if(!t)return;const{id:s,searchListIds:a,sourcesPerSle:n,flagUpdates:i}=t;for(;a.length>0;){const e=a.splice(0,ra),t=Date.now(),o=e.map((e=>({searchListId:e,sources:n.get(e)||new Map})));await h.Z.transaction("rw",[h.Z.searchList,h.Z.filteringQueue,h.Z.flaggingQueue,h.Z.buffer,h.Z.imap],(async()=>{const t=await na.call(o,i);v.QO.updateIndex({sleUpdates:t}),Object.keys(i).length>0&&await pt.Z.call(e,i),n.size>0&&await aa.call(t),Ct.call();const r={id:s,searchListIds:a,sourcesPerSle:n,flagUpdates:i};await h.Z.flaggingQueue.put(r)}));const r=Date.now();ra=oa(ra,r-t),ve.filter()}await h.Z.flaggingQueue.delete(s),await ca(e)}N.open();const da={updateThreads:Ce.updateThreads,rerunThreading:Ce.rerunThreading,start:async function(){await Promise.all([rs(),g.Z.initFilters(),X.Z.initFolders(),new Promise((e=>{const t=C.Z.adjustBatchSize.bind(void 0,100,1e4,100);let s=100,a=-1;!function n(){const i=Date.now();h.Z.threading.where("id").above(a).limit(s).toArray().then((o=>(V(o),o.reduce(((e,t)=>e.then((()=>$(t)))),Promise.resolve()).then((()=>{if(o.length===s){const{id:e}=o[s-1];a=e;const r=Date.now();s=t(s,r-i),n()}else k.clear(),e()})))))}()})),ce.Z.initMailingLists()])},stop:function(){void 0!==ns&&ns("Clearing UID sequence sets."),os(),is={},g.Z.clear(),ce.Z.clear(),X.Z.clear(),D(),x={level:0,children:new Map},q.Z.clear()},addAccount:async function(e,t){const s=e.MAIL_EMAIL,{accountType:a,offline:n}=e,i=a===R.s9.POP,o=a===R.s9.IMAP;if(!i&&!o)throw new Error(`Trying to add account ${s} of unsupported type ${a}`);const r=i?{[R.e9]:[{name:R.Gf,path:R.Gf,delimiter:".",type:R.e9}],[R.Nz]:[{name:R.N1,path:R.N1,delimiter:".",type:R.Nz}]}:{};await z.Z.add(s,r,t),await q.Z.addAccounts({[s]:{capability:t,folders:r}});const c=await f.Z.foldersToFilters(s,r);g.Z.updateFilters(c),n||(i?await lt():ta.connectIMAPClient(e))},flushBuffer:Ct.call,updateFlags:async function(){if(!ia){ia=!0;try{await ca()}finally{ia=!1}}}};function la(e){if(e.origin!==T.oP)return;const{background:t}=e.data;if(t){const{promiseId:s,func:a,args:n=[]}=t;Promise.resolve().then((()=>da[a](...n))).then((t=>{e.source.postMessage({background:{promiseId:s,results:t}})})).catch((t=>{t=t.message||t,e.source.postMessage({background:{promiseId:s,error:t}})}))}}self.addEventListener("install",(e=>{self.skipWaiting()}));let ua=!1;const fa=new Map;function ha(e){const t=e.id;if("number"!=typeof t||"normal"!==e.type&&"popup"!==e.type)return;const s=(0,d.Z)(e.vivExtData);s.ext_id||(s.ext_id=c()()),delete s.isDropped,s.windowType=e.type,o.Z.windows.update(t,{vivExtData:JSON.stringify(s)})}function pa(){o.Z.windows.getAll({populate:!0},(e=>{for(var t=0;t<e.length;t++)ha(e[t]);o.Z.windows.onCreated.addListener((e=>{ha(e)})),o.Z.windows.onRemoved.addListener((async e=>{l.Z.utilities.broadcastMessage({windowRemoved:{windowId:e}}),l.Z.devtoolsPrivate.closeDevtools(1,e,(e=>{}))}))}))}o.Z.runtime.onMessage.addListener(((e,t,s)=>{if(e)if(e.setNavigationState){const t=e.setNavigationState;fa.set(t.tabId,t)}else if(e.getNavigationState&&e.getNavigationState.tabId&&"number"==typeof e.getNavigationState.tabId){const t=e.getNavigationState.tabId,a=fa.get(t);a&&s(a),fa.delete(t)}else e.dispatchAction&&o.Z.runtime.sendMessage({...e})})),async function(){ua||(ua=!0,self.addEventListener("message",la,!1),await Promise.all([a.Z.loadPromise(),n.Z.loadPromise(),i.Z.loadPromise()]),(0,u.aE)(),pa())}()}},s={};function a(e){var n=s[e];if(void 0!==n)return n.exports;var i=s[e]={id:e,loaded:!1,exports:{}};return t[e].call(i.exports,i,i.exports,a),i.loaded=!0,i.exports}a.m=t,e=[],a.O=(t,s,n,i)=>{if(!s){var o=1/0;for(l=0;l<e.length;l++){for(var[s,n,i]=e[l],r=!0,c=0;c<s.length;c++)(!1&i||o>=i)&&Object.keys(a.O).every((e=>a.O[e](s[c])))?s.splice(c--,1):(r=!1,i<o&&(o=i));if(r){e.splice(l--,1);var d=n();void 0!==d&&(t=d)}}return t}i=i||0;for(var l=e.length;l>0&&e[l-1][2]>i;l--)e[l]=e[l-1];e[l]=[s,n,i]},a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),a.j=670,(()=>{var e={670:0};a.O.j=t=>0===e[t];var t=(t,s)=>{var n,i,[o,r,c]=s,d=0;if(o.some((t=>0!==e[t]))){for(n in r)a.o(r,n)&&(a.m[n]=r[n]);if(c)var l=c(a)}for(t&&t(s);d<o.length;d++)i=o[d],a.o(e,i)&&e[i]&&e[i][0](),e[o[d]]=0;return a.O(l)},s=self.webpackChunkgapp_browser_react=self.webpackChunkgapp_browser_react||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var n=a.O(void 0,[739],(()=>a(25443)));n=a.O(n)})();